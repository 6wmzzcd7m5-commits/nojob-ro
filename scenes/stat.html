<div class="panel grid" style="grid-column: span 2; gap: 10px;">
    <div class="flex" style="border-bottom: 1px solid var(--bd); padding-bottom: 5px;">
        <span class="en">ALLOCATE POINTS</span>
        <span class="cn">屬性點分配</span>
        <b class="c-n" id="stat-pts-display">0</b>
    </div>

    <div class="grid g-1" style="gap: 5px;">
        <div id="stat-rows-container" class="grid g-1" style="gap: 8px;"></div>
    </div>

    <button class="btn-neon" onclick="st.confirm()" style="margin-top: 10px; width: 100%;">
        <span class="en">CONFIRM & SAVE</span>
        <span class="cn">確認並存檔</span>
    </button>
</div>

<script>
/**
 * STAT ALLOCATION LOGIC
 * Manages the spending of points earned in reward.html.
 */
const st = {
    keys: ['str', 'agi', 'vit', 'int', 'dex', 'luk'],
    labels: {
        str: ['STR', '力量'], agi: ['AGI', '敏捷'], vit: ['VIT', '體質'],
        int: ['INT', '智力'], dex: ['DEX', '靈巧'], luk: ['LUK', '幸運']
    },

    init() {
        this.renderRows();
        this.updateDisplay();
    },

    renderRows() {
        const container = document.getElementById('stat-rows-container');
        container.innerHTML = '';
        
        this.keys.forEach(k => {
            const row = document.createElement('div');
            row.className = "flex";
            row.style.justifyContent = "space-between";
            row.innerHTML = `
                <div style="flex: 1;">
                    <b style="font-size: 0.8rem;">${this.labels[k][G.s.l === 'en' ? 0 : 1]}</b>
                </div>
                <div class="flex" style="gap: 15px;">
                    <span id="st-val-${k}" style="min-width: 20px; text-align: center;">0</span>
                    <button class="btn-sm" onclick="st.add('${k}')" 
                            style="width: 30px; height: 30px; border-radius: 50%;">+</button>
                </div>
            `;
            container.appendChild(row);
        });
    },

    updateDisplay() {
        // Update point counter
        document.getElementById('stat-pts-display').innerText = G.p.pts;
        
        // Update local row values
        this.keys.forEach(k => {
            document.getElementById(`st-val-${k}`).innerText = G.p[k];
        });

        // Trigger the Master Shell's render to update the HUD stats (ATK, FLEE, etc)
        G.render(); 
    },

    add(key) {
        if (G.p.pts > 0) {
            G.p[key]++;
            G.p.pts--;
            this.updateDisplay();
        } else {
            G.log("No points left!", 'c-red');
        }
    },

    confirm() {
        G.sv(); // Save final stats to localStorage
        
        // Check for Job Change milestones
        const req = DB.jobs[G.p.job].next.length > 1 ? 10 : 30;
        if (G.p.lvl >= req && !G.p.arch && DB.jobs[G.p.job].next.length > 0) {
            G.loadScene('jobs');
        } else {
            G.loadScene('mnu');
        }
    }
};

st.init();
</script>
