<div class="panel grid g-1" style="grid-column: span 2;">
    <div class="panel" style="text-align: center; border-style: dashed; background: rgba(57, 255, 20, 0.05); min-height: 80px;">
        <div id="combat-status" class="c-n" style="font-size: 0.7rem; margin-bottom: 5px;">[AUTO_COMBAT_ACTIVE]</div>
        <div id="skill-proc-notify" class="c-rare" style="font-weight: 900; font-size: 1.4rem; text-shadow: 0 0 10px var(--rare); height: 30px; transition: 0.2s;"></div>
    </div>

    <div class="panel" style="margin-top: 5px; background: rgba(255,0,0,0.05); border-color: var(--hp);">
        <div class="flex">
            <b id="e-name" class="c-red" style="letter-spacing: 1px;">SCANNING...</b>
            <span class="c-red" style="font-size: 0.8rem;">HP: <span id="e-hp-txt">0</span></span>
        </div>
        <progress id="e-hp-bar" value="0" max="100" style="border-color: var(--hp); height: 10px;"></progress>
    </div>
    
    <div style="text-align: center; font-size: 0.6rem; color: #444;">[ SYSTEM_OVERRIDE: MANUAL_INPUT_DISABLED ]</div>
</div>

<script>
const btl = {
    mob: null,
    tmP: null, // Player Heartbeat
    tmE: null, // Enemy Heartbeat
    
    init() {
        // 1. Fetch Monster from Aegis DB
        this.mob = window.getMonster(G.s.f);
        this.mob.mhp = this.mob.hp;
        
        // 2. Setup UI
        el('e-name').innerText = this.mob.n.toUpperCase();
        el('e-box').setAttribute('data-mob', this.mob.n);
        this.updateE();
        
        G.log(`ENGAGING_TARGET: ${this.mob.n}`, "c-red");

        // 3. Set Attack Speeds
        // Player speed scales with AGI (Base 2s, caps at 0.6s)
        const pSpeed = Math.max(600, 2000 - (G.p.agi * 25));
        
        // 4. Start the Battle Heartbeats
        this.tmP = setInterval(() => this.playerTurn(), pSpeed);
        this.tmE = setInterval(() => this.monsterTurn(), 2500);
    },

    updateE() {
        el('e-hp-bar').value = this.mob.hp;
        el('e-hp-bar').max = this.mob.mhp;
        el('e-hp-txt').innerText = Math.max(0, this.mob.hp).toLocaleString();
    },

    playerTurn() {
        if (this.mob.hp <= 0) return;
        
        let dmg = 0;
        let logMsg = "";
        let logColor = "";

        // --- SKILL PROC LOGIC ---
        // 15% base chance + 0.5% per LUK point
        const procChance = 15 + (G.p.luk * 0.5);
        const skillKeys = Object.keys(G.p.sk);
        let usedSkill = null;

        if (Math.random() * 100 < procChance && skillKeys.length > 0) {
            const randKey = skillKeys[Math.floor(Math.random() * skillKeys.length)];
            const sk = window.DB_SKILLS[randKey];
            
            if (G.p.sp >= sk.sp) {
                G.p.sp -= sk.sp;
                usedSkill = randKey;

                // Execute Skill Effects
                if (sk.type === 'phys') dmg = Math.floor((G.p.str * 2.2 + G.p.lvl) * sk.val);
                if (sk.type === 'mag') dmg = Math.floor((G.p.int * 2.2 + G.p.lvl) * sk.val);
                if (sk.type === 'heal_pct') {
                    const hAmt = Math.floor(G.p.mh * sk.val);
                    G.p.hp = Math.min(G.p.mh, G.p.hp + hAmt);
                    G.log(`CRITICAL_HEAL: +${hAmt}HP`, "c-n");
                }

                // UI Notification
                const notifier = el('skill-proc-notify');
                notifier.innerText = `>> ${randKey.toUpperCase()} <<`;
                notifier.style.opacity = "1";
                setTimeout(() => { notifier.style.opacity = "0"; }, 500);
                
                logMsg = `PROC: [${randKey}]!!`;
                logColor = "c-rare";
            }
        }

        // --- BASIC ATTACK (If no skill proc or no SP) ---
        if (!usedSkill) {
            const hitRate = 80 + (G.p.dex + G.p.lvl) - this.mob.flee;
            if (Math.random() * 100 > hitRate) {
                logMsg = "MISS";
                logColor = "entry";
            } else {
                dmg = Math.floor(G.p.str * 2.5 + G.p.lvl);
                // Basic Critical Check
                if (Math.random() * 100 < (G.p.luk * 0.4)) {
                    dmg = Math.floor(dmg * 1.5);
                    logMsg = `CRITICAL: ${dmg}`;
                    logColor = "c-yel";
                } else {
                    logMsg = `HIT: ${dmg}`;
                }
            }
        }

        if (dmg > 0) {
            this.mob.hp -= dmg;
            el('e-spr').classList.add('hit-shake');
            setTimeout(() => el('e-spr').classList.remove('hit-shake'), 150);
        }

        if (logMsg) G.log(logMsg, logColor);
        this.updateE();
        G.render();
        if (this.mob.hp <= 0) this.win();
    },

    monsterTurn() {
        if (this.mob.hp <= 0) return;

        // Player Flee Check
        const fleeRate = (G.p.agi + G.p.lvl) - this.mob.hit;
        if (Math.random() * 100 < fleeRate) {
            G.log("FLEE!", "c-n");
        } else {
            let dmg = Math.max(1, this.mob.atk - Math.floor(G.p.vit * 1.5));
            G.p.hp -= dmg;
            G.log(`${this.mob.n.toUpperCase()} ATTACK: ${dmg}`, "c-red");
            el('p-spr').classList.add('hit-shake');
            setTimeout(() => el('p-spr').classList.remove('hit-shake'), 150);
        }

        G.render();
        if (G.p.hp <= 0) this.lose();
    },

    win() {
        this.cleanup();
        G.log(`TARGET_DEFEATED! EARNED ${this.mob.zeny}z`, "c-yel");
        G.p.zeny += this.mob.zeny;
        
        // 1 Floor = 1 Level Up Logic
        G.p.lvl++;
        G.s.f++;
        
        G.sv(); // Auto-Save
        setTimeout(() => G.loadScene('reward'), 1000);
    },

    lose() {
        this.cleanup();
        alert("CRITICAL_FAILURE: IDENTITY_TERMINATED.");
        localStorage.clear();
        location.reload();
    },

    cleanup() {
        clearInterval(this.tmP);
        clearInterval(this.tmE);
    }
};

btl.init();
</script>
