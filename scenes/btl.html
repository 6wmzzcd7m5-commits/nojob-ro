<div class="panel grid g-2" style="grid-column: span 2; border-style: double; border-width: 3px;">
    <div id="btl-cmds" class="grid g-2" style="grid-column: span 2;">
        <button onclick="btl.act('atk')">CMD://ATTACK</button>
        <button onclick="btl.showSkills()">CMD://SKILLS</button>
        <button onclick="btl.act('pot')" style="color: var(--hp); border-color: var(--hp);">CMD://RECOVERY</button>
        <button onclick="btl.escape()" style="border-color: #666; color: #666;">CMD://ABORT</button>
    </div>

    <div id="btl-sk" class="grid g-2" style="grid-column: span 2; display: none;">
        </div>
</div>

<script>
const btl = {
    init() {
        G.s.b = true; 
        G.s.patb = 0; G.s.eatb = 0;
        
        // Tiered Mob selection
        const tier = Math.min(1, Math.floor(G.s.f / 10));
        const pool = DB.mobs[tier];
        G.s.mob = { ...pool[Math.floor(Math.random() * pool.length)], mhp: 0 };
        G.s.mob.mhp = G.s.mob.hp;

        G.log(`TARGET_ACQUIRED: ${G.s.mob.n.toUpperCase()}`, 'c-red');
        
        // Set Foe Metadata on Stage
        el('e-box').setAttribute('data-mob', G.s.mob.n);
        
        this.startClock();
    },

    startClock() {
        clearInterval(G.s.tm);
        G.s.tm = setInterval(() => {
            if (!G.s.b) return;

            // Clock Logic
            G.s.patb += (2 + G.p.agi * 0.1);
            G.s.eatb += 2.2; // Slightly faster enemy scaling

            if (G.s.eatb >= 100) {
                G.s.eatb = 0;
                this.hitP();
            }
            if (G.s.patb >= 100) {
                G.s.patb = 100;
                this.toggleUI(true);
            }

            el('atb-p').value = G.s.patb;
            el('atb-e').value = G.s.eatb;
        }, 50);
    },

    act(type, val) {
        if (G.s.patb < 100 && type !== 'pot') return;
        
        const m = G.s.mob;
        const atk = Math.floor(G.p.str * 2.5 + G.p.lvl * 2);

        if (type === 'atk') {
            m.hp -= atk;
            G.log(`DEALT_${atk}_DMG -> ${m.n}`);
        } else if (type === 'sk') {
            const s = DB.skills[val];
            if (G.p.sp < s.sp) { G.log("ERR://ENERGY_LOW", "c-red"); return; }
            G.p.sp -= s.sp;
            const dmg = Math.floor(atk * s.val);
            m.hp -= dmg;
            G.log(`EXEC_${val.toUpperCase()}: ${dmg}_DMG`);
        } else if (type === 'pot') {
            if (G.p.pots > 0) {
                G.p.pots--; G.p.hp = Math.min(G.p.mh, G.p.hp + 50);
                G.log("SYS://RECOVERY_COMPLETE", "c-n");
            } else { G.log("ERR://SUPPLY_EMPTY", "c-red"); return; }
        }

        this.toggleUI(false);
        G.s.patb = 0;
        G.render();

        if (m.hp <= 0) this.win();
    },

    hitP() {
        const dmg = Math.max(1, G.s.mob.atk - Math.floor(G.p.lvl / 3));
        G.p.hp -= dmg;
        G.log(`INCOMING_DMG: ${dmg}`, "c-red");
        el('p-box').classList.add('anim-shake');
        setTimeout(() => el('p-box').classList.remove('anim-shake'), 200);
        G.render();

        if (G.p.hp <= 0) {
            clearInterval(G.s.tm);
            G.loadScene('gameover');
        }
    },

    win() {
        clearInterval(G.s.tm);
        G.s.b = false;
        G.p.xp += G.s.mob.xp;
        G.log(`OBJECTIVE_COMPLETE: +${G.s.mob.xp}XP`, "c-n");
        el('e-box').removeAttribute('data-mob');
        
        if (G.p.xp >= G.p.next) G.loadScene('reward');
        else G.loadScene('mnu');
    },

    toggleUI(on) {
        el('btl-cmds').style.opacity = on ? "1" : "0.3";
        el('btl-cmds').style.pointerEvents = on ? "auto" : "none";
    },

    showSkills() {
        const skBox = el('btl-sk');
        el('btl-cmds').style.display = 'none';
        skBox.style.display = 'grid';
        skBox.innerHTML = '<button onclick="btl.hideSkills()" style="grid-column:span 2">BACK_TO_ROOT</button>';
        for (let s in G.p.sk) {
            const b = document.createElement('button');
            b.innerHTML = `${s.toUpperCase()}<br><small>${DB.skills[s].sp}SP</small>`;
            b.onclick = () => this.act('sk', s);
            skBox.appendChild(b);
        }
    },

    hideSkills() {
        el('btl-sk').style.display = 'none';
        el('btl-cmds').style.display = 'grid';
    },

    escape() {
        if (confirm("ABORT_ENCOUNTER?")) {
            clearInterval(G.s.tm);
            G.s.b = false;
            el('e-box').removeAttribute('data-mob');
            G.loadScene('mnu');
        }
    }
};
btl.init();
</script>
