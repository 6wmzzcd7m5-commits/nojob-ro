name: Secure Leaderboard Update
on:
  issues:
    types: [opened]

jobs:
  update-leaderboard:
    if: contains(github.event.issue.title, 'SCORE')
    runs-on: ubuntu-latest
    permissions:
      contents: write
      issues: write

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Process Score Submission
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const issueBody = context.payload.issue.body;
            const user = context.payload.issue.user.login;
            
            [cite_start]// 1. Anti-Bot: Check account age (minimum 7 days) [cite: 33]
            const userRes = await github.rest.users.getByUsername({ username: user });
            const created = new Date(userRes.data.created_at);
            const now = new Date();
            const ageDays = (now - created) / (1000 * 60 * 60 * 24);
            
            if (ageDays < 7) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: "‚ö†Ô∏è Error: GitHub account must be at least 7 days old to submit scores."
              });
              await github.rest.issues.update({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                state: 'closed'
              });
              return;
            }

            // 2. Data Extraction
            const jsonMatch = issueBody.match(/```json\n([\s\S]*?)\n```/);
            if (!jsonMatch) return;
            const data = JSON.parse(jsonMatch[1]);
            
            [cite_start]// 3. Anti-Tamper: Recalculate DJB2 Hash [cite: 31, 34]
            const SALT = "SECRET_KEY_999"; 
            const raw = `${data.n}-${data.j}-${data.f}-${SALT}`;
            let serverHash = 0;
            for (let i = 0; i < raw.length; i++) {
              serverHash = ((serverHash << 5) - serverHash) + raw.charCodeAt(i);
              serverHash |= 0;
            }

            if (serverHash.toString() !== data.h) {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.issue.number,
                body: "üö´ Security Error: Hash signature mismatch. Submission rejected."
              });
              return;
            }

            [cite_start]// 4. Sanitization & Update [cite: 14, 34]
            const name = data.n.replace(/[^a-z0-9]/gi, '').substring(0, 10);
            let leaderboard = JSON.parse(fs.readFileSync('leaderboard.json', 'utf8'));
            
            leaderboard.push({ n: name, j: data.j, f: data.f });
            leaderboard.sort((a, b) => b.f - a.f);
            leaderboard = leaderboard.slice(0, 10); // Keep Top 10
            
            fs.writeFileSync('leaderboard.json', JSON.stringify(leaderboard, null, 2));

      - name: Commit and Push Changes
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          git add leaderboard.json
          git commit -m "üèÜ Leaderboard updated via Issue #${{ github.event.issue.number }}"
          git push

      - name: Close Issue
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.payload.issue.number,
              state: 'closed',
              labels: ['processed']
            });
