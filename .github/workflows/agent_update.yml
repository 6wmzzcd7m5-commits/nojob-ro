name: Gemini Agent Update
on:
  issues:
    types: [opened]

permissions:
  contents: write
  issues: write

jobs:
  apply-code-change:
    if: startsWith(github.event.issue.title, 'UPDATE:')
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v3

      - name: Extract and Apply Code
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const body = context.payload.issue.body;
            
            // Regex to find the filename in the title and the code block in the body
            const fileMatch = context.payload.issue.title.match(/UPDATE:\s*(.+)/);
            const codeMatch = body.match(/```(?:html|css|javascript|json)?\s*([\s\S]*?)```/);
            
            if (fileMatch && codeMatch) {
              const fileName = fileMatch[1].trim();
              const newContent = codeMatch[1].trim();
              
              // Apply the change
              fs.writeFileSync(fileName, newContent);
              console.log(`Updated ${fileName}`);
            } else {
              core.setFailed("Could not parse filename or code block.");
            }

      - name: Commit and Push
        run: |
          git config --global user.name "GeminiAgent"
          git config --global user.email "agent@noreply.github.com"
          git add .
          git commit -m "Gemini Agent: ${{ github.event.issue.title }}"
          git push

      - name: Close Issue
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: "ðŸš€ **Agent Update Successful:** Changes have been pushed to main."
            });
            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              state: 'closed'
            });
