<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Jobless RO: Origins</title>
<style>
    :root { 
        --bg:#050505; --p:#1a1a1a; --bd:#4a4a4a; --n:#00ff00; 
        --t:#ffffff; --d:#aaaaaa; --hp:#ff6666; --sp:#66ccff; --r:#ffff66; 
        --m:#66ccff; --f:#ff99cc; 
        /* RO uses Tahoma/Arial for UI. Impact fits the Damage numbers. */
        --font:'Tahoma', 'Arial', sans-serif; 
    }
    * { box-sizing:border-box; user-select:none; -webkit-tap-highlight-color:transparent; }
    
    body {
        background: var(--bg); color: var(--t); font-family: var(--font); font-size: 11px;
        margin: 0; padding: 0; width: 100vw; height: 100dvh;
        display: flex; justify-content: center; align-items: center; overflow: hidden;
    }

    #app {
        width: 100%; max-width: 500px; height: 100%; 
        display: flex; flex-direction: column; gap: 4px; padding: 8px;
        background: url('data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0IiBoZWlnaHQ9IjQiPgo8cmVjdCB3aWR0aD0iNCIgaGVpZ2h0PSI0IiBmaWxsPSIjMDUwNTA1Ii8+CjxyZWN0IHdpZHRoPSIxIiBoZWlnaHQ9IjEiIGZpbGw9IiMxMTEiLz4KPC9zdmc+'); /* Subtle pattern */
        position: relative;
    }

    /* Utils */
    .flex { display:flex; justify-content:space-between; align-items:center; }
    .grid { display:grid; gap:4px; } .g-2 { grid-template-columns:1fr 1fr; } .g-6 { grid-template-columns:repeat(6,1fr); }
    
    /* RO Text Styles with Outlines */
    .c-n { color:var(--n); text-shadow: 1px 1px 0 #000; } 
    .c-h { color:var(--hp); text-shadow: 1px 1px 0 #000; } 
    .c-d { color:var(--d); } 
    .c-r { color:var(--r); font-weight:bold; text-shadow: 1px 1px 0 #000; }
    
    .panel { 
        border:1px solid var(--bd); background:rgba(20,20,20,0.9); 
        padding:6px; border-radius:3px; box-shadow: 2px 2px 5px rgba(0,0,0,0.5); 
    }
    .hide { display:none!important; }
    
    button {
        background: linear-gradient(to bottom, #4a4a4a, #2a2a2a);
        color: #fff; border: 1px solid #666; border-radius: 3px;
        padding: 8px; font: inherit; font-weight: bold; cursor: pointer; 
        text-transform: uppercase; text-shadow: 1px 1px 0 #000;
        box-shadow: 0 2px 0 #111;
    }
    button:active, button.active { 
        background: #2a2a2a; color:#eee; border-color:#888; 
        transform: translateY(2px); box-shadow: none;
    }
    .btn-sm { padding:3px 6px; font-size:10px; }
    .btn-red { background: linear-gradient(to bottom, #844, #522); border-color:#a55; }
    .btn-blue { background: linear-gradient(to bottom, #448, #225); border-color:#55a; }
    
    input { 
        background:#111; border:1px solid #555; color:#fff; padding:8px; 
        width:100%; font:inherit; font-size: 12px;
    }
    
    /* UI Components */
    .g-tag { 
        padding:8px 12px; border:1px solid #444; cursor:pointer; 
        color:#888; background:#111; transition:0.2s; font-weight:bold;
    }
    .g-tag.m.active { color:#fff; background:#005577; border-color:var(--m); }
    .g-tag.f.active { color:#fff; background:#770044; border-color:var(--f); }

    #rank-ui { position:absolute; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.9); z-index:99; padding:20px; display:flex; flex-direction:column; justify-content:center; align-items:center; }
    #rank-box { width:100%; max-width:400px; border:1px solid #666; background:#1a1a1a; padding:15px; max-height:80%; overflow-y:auto; box-shadow: 0 0 20px #000; }
    .rank-row { display:flex; justify-content:space-between; border-bottom:1px solid #333; padding:5px 0; font-size:11px; }
    
    /* Sprite Engine */
    .cf { width:32px; height:32px; position:relative; overflow:hidden; border:1px solid #444; background:#000; border-radius:2px; margin-right:8px; flex-shrink:0; }
    .spr { position:absolute; top:4px; left:6px; width:20px; height:30px; animation:i 1s infinite steps(2); }
    .hd { width:14px; height:12px; background:#fca; position:absolute; left:3px; top:0; z-index:5; border:1px solid rgba(0,0,0,0.2); border-bottom:none; }
    .hr { width:16px; height:7px; background:#853; position:absolute; left:2px; top:-2px; z-index:6; }
    .ro-m .hr { border-radius:4px 4px 0 0; } .ro-f .hr { width:18px; left:1px; border-radius:8px 8px 0 0; }
    .bd { width:12px; height:11px; background:#eee; position:absolute; left:4px; top:11px; z-index:2; }
    @keyframes i { 0%,100%{transform:translateY(0)} 50%{transform:translateY(1px)} }
    
    /* Job Colors */
    .j-0 .bd{background:linear-gradient(to bottom,#fff 60%,#dca 60%)}
    .j-1 .bd{background:linear-gradient(to bottom,#d84 50%,#468 50%);border-top:2px solid #b62}
    .j-2 .bd{background:linear-gradient(90deg,#348 20%,#eee 20%,#eee 80%,#348 80%);border-bottom:3px solid #642}
    .j-3 .bd{background:linear-gradient(to bottom,#637 40%,#fca 40%,#fca 60%,#543 60%)}
    .j-4 .bd{background:linear-gradient(to bottom,#473 60%,#db9 60%);border-left:2px solid #fca}
    .j-5 .bd{background:linear-gradient(90deg,#fff 40%,#d44 40%,#d44 60%,#fff 60%)}
    .j-6 .bd{background:linear-gradient(90deg,#eee 30%,#a44 30%,#a44 70%,#eee 70%);border-bottom:2px solid #334}

    /* Bars & Logs */
    progress { width:100%; height:6px; appearance:none; border:none; background:#222; display:block; border-radius:2px; overflow:hidden; }
    progress::-webkit-progress-bar { background:#222; } 
    progress::-webkit-progress-value { transition:width 0.1s linear; }
    #bh::-webkit-progress-value { background:linear-gradient(to bottom, #ff8888, #cc4444); } 
    #bs::-webkit-progress-value { background:linear-gradient(to bottom, #88ccff, #4488cc); }
    #ap::-webkit-progress-value { background:#55ff55; } #ae::-webkit-progress-value { background:#ff5555; }
    
    #log { 
        flex:1; overflow-y:auto; font-size:11px; 
        border-top:1px solid #444; padding-top:5px; 
        display:flex; flex-direction:column-reverse; 
        background: rgba(0,0,0,0.3);
    }
    .lr { padding: 1px 0; border-bottom: 1px solid rgba(255,255,255,0.05); }
    
    /* Damage Numbers Style */
    .l-dmg { color: #fff; font-weight: bold; text-shadow: -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000, 1px 1px 0 #000; }
    .l-crit { font-family:'Impact',sans-serif; font-size:13px; color:#ffdd00; letter-spacing:1px; text-shadow: 2px 2px 0 #ff0000, -1px -1px 0 #000; }
    .l-miss { color: #d00; opacity: 0.8; font-style: italic; }
    
    .stat-cell { text-align:center; font-size:10px; border-top:1px dashed #444; padding-top:4px; color:#aaa; }
    .stv { color: #fff; font-weight: bold; display: block; font-size: 11px; }
</style>
</head>
<body>

<div id="app">
    <div id="rank-ui" class="hide">
        <div id="rank-box">
            <div class="flex" style="border-bottom:2px solid var(--r); margin-bottom:10px; color:var(--r); font-weight:bold;">
                <span>TOP 10</span> <button class="btn-sm btn-red" onclick="G.closeRank()">X</button>
            </div>
            <div id="rank-list">Loading...</div>
            <div style="font-size:10px; color:#888; margin-top:10px; text-align:center;">Updates every 60s.</div>
        </div>
    </div>

    <header class="panel grid">
        <div class="flex" style="border-bottom:1px dashed #444; padding-bottom:5px;">
            <div class="flex" style="gap:4px">
                <button class="btn-sm btn-red" onclick="G.wipe()">[R]</button>
                <button class="btn-sm btn-blue" onclick="G.exp()">[S]</button>
                <button class="btn-sm btn-blue" onclick="document.getElementById('fi').click()">[L]</button>
                <input type="file" id="fi" style="display:none" onchange="G.imp(this)">
                <button class="btn-sm" onclick="G.lang()">EN/‰∏≠</button>
                <button id="b-au" class="btn-sm" onclick="G.tAu()">AUTO</button>
            </div>
            <div class="flex" style="gap:2px">
                <button class="btn-sm" id="s10" onclick="G.spd(10)">1x</button>
                <button class="btn-sm" id="s30" onclick="G.spd(30)">3x</button>
                <button class="btn-sm" id="s99" onclick="G.spd(99)">MAX</button>
            </div>
        </div>
        <div class="flex" style="justify-content:flex-start;">
            <div class="cf"><div id="spr" class="spr ro-m"><div class="hr"></div><div class="hd"></div><div class="bd"></div></div></div>
            <div style="flex:1;">
                <div class="flex"><div><b id="un" class="c-n" style="font-size:12px"></b> <span id="uj" class="c-d" style="font-size:10px"></span></div><div style="font-size:11px">Lv. <span id="ul" class="c-r">1</span></div></div>
                <div class="c-n" style="font-size:10px; margin-top:2px;" id="ulo"></div>
            </div>
        </div>
        <div class="grid g-2">
            <div style="font-size:10px"><div class="flex"><span>HP</span> <span id="uh"></span></div><progress id="bh" value="100" max="100"></progress></div>
            <div style="font-size:10px"><div class="flex"><span>SP</span> <span id="us"></span></div><progress id="bs" value="20" max="20"></progress></div>
        </div>
        <div class="grid g-6">
            <div class="stat-cell">STR<span id="vstr" class="stv">1</span></div>
            <div class="stat-cell">AGI<span id="vagi" class="stv">1</span></div>
            <div class="stat-cell">VIT<span id="vvit" class="stv">1</span></div>
            <div class="stat-cell">INT<span id="vint" class="stv">1</span></div>
            <div class="stat-cell">DEX<span id="vdex" class="stv">1</span></div>
            <div class="stat-cell">LUK<span id="vluk" class="stv">1</span></div>
        </div>
    </header>

    <section id="btl" class="panel hide">
        <div class="flex"><span id="en" style="font-weight:bold; color:var(--hp); text-shadow:1px 1px 0 #000;">TARGET</span> <span id="eh" class="c-d" style="font-size:10px"></span></div>
        <div class="grid" style="margin-top:5px;">
            <div class="flex" style="font-size:10px"><span class="c-n">ATB</span> <progress id="ap" value="0" max="1000" style="width:85%"></progress></div>
            <div class="flex" style="font-size:10px"><span class="c-h">FOE</span> <progress id="ae" value="0" max="1000" style="width:85%"></progress></div>
        </div>
    </section>

    <nav id="ctl" class="grid g-2" style="min-height:60px;"></nav>
    <main id="log"></main>
</div>

<script>
// --- CONFIGURATION ---
const GH_USER = "6wmzzcd7m5-commits"; 
const GH_REPO = "nojob-ro"; 
const RAW_URL = `https://raw.githubusercontent.com/${GH_USER}/${GH_REPO}/main/leaderboard.json`;
const SALT = "SECRET_KEY_999"; 

// --- DATABASE ---
const J=[{n:'Novice',c:'ÂàùÂøÉËÄÖ',hp:60,sp:20,as:50},{n:'Swordman',c:'ÂäçÂ£´',hp:150,sp:40,as:45},{n:'Mage',c:'Ê≥ïÂ∏´',hp:80,sp:120,as:60},{n:'Thief',c:'ÁõúË≥ä',hp:110,sp:50,as:35},{n:'Archer',c:'ÂºìÁÆ≠Êâã',hp:100,sp:60,as:40},{n:'Acolyte',c:'Êúç‰∫ã',hp:90,sp:100,as:55},{n:'Merchant',c:'ÂïÜ‰∫∫',hp:120,sp:50,as:50}];
const B=[{n:'Angeling',c:'Â§©‰ΩøÊ≥¢Âà©',h:1500,a:50,x:1000},{n:'GT Bug',c:'ÈªÉÈáëËü≤',h:5000,a:120,x:3500},{n:'Eddga',c:'ËôéÁéã',h:12000,a:250,x:12000},{n:'Osiris',c:'Ê≠êË•øÈáåÊñØ',h:30000,a:600,x:40000},{n:'Baphomet',c:'Â∑¥È¢®Áâπ',h:99999,a:1500,x:99999}];
const SK0=[{n:'First Aid',c:'Á∑äÊÄ•Ê≤ªÁôÇ',v:20,t:'h'},{n:'Bash',c:'ÁãÇÊìä',v:1.4,t:'p'},{n:'Napalm',c:'ÂøÉÈùàÁàÜÁ†¥',v:1.5,t:'m'}];
const SKJ={
    Swordman:[{n:'Bash',c:'ÁãÇÊìä',v:1.5,t:'p'},{n:'Magnum',c:'ÊÄíÁàÜ',v:1.2,t:'p'},{n:'Berserk',c:'ÁãÇÊö¥',t:'a'}],
    Mage:[{n:'FireBolt',c:'ÁÅ´ÁÆ≠Ë°ì',v:2.0,t:'m'},{n:'ColdBolt',c:'ÂÜ∞ÁÆ≠Ë°ì',v:2.0,t:'m'},{n:'Lightning',c:'Èõ∑ÊìäË°ì',v:2.0,t:'m'}],
    Thief:[{n:'Envenom',c:'ÊñΩÊØí',v:1.5,t:'p'},{n:'Double',c:'‰∫åÂàÄÈÄ£Êìä',t:'a'},{n:'Hiding',c:'ÂÅΩË£ù',t:'a'}],
    Acolyte:[{n:'HolyLight',c:'Á•ûËÅñ‰πãÂÖâ',v:1.8,t:'m'},{n:'Heal',c:'Ê≤ªÁôíË°ì',v:50,t:'h'},{n:'Divine',c:'Â§©‰Ωø‰πãË≠∑',t:'a'}]
};
const LOC_EN=["Prontera","Payon","Orc Dungeon","Glast Heim","Clock Tower","Thanatos"];
const LOC_CN=["ÊôÆÈöÜÂæ∑Êãâ","ÊñêÊèö","Áç∏‰∫∫Ê¥ûÁ©¥","Âè§Âüé","ÈêòÂ°î","Â°îÁ¥çÊâòÊñØ"];
const MON_EN=["Poring","Wolf","Orc","Raydric","Alarm","Thanatos"];
const MON_CN=["Ê≥¢Âà©","Áãº","Áç∏‰∫∫","Ê∑±Ê∑µÈ®éÂ£´","ÊúΩÈ≠î","Â°îÁ¥çÊâòÊñØ"];

const T={en:{st:"ID REGISTRATION",ph:"ENTER NAME",ea:"EASY",ha:"HARD",mi:"MISSION: Play to unlock secrets.",on:"AUTO:ON",off:"AUTO:OFF",lv:"LV",pts:"PTS",ok:"OK",stb:"START",mvp:"MVP DETECTED!",fi:"FIGHT",re:"REST",nx:"NEXT FLOOR",win:"CLEARED",vic:"VICTORY",go:"GAME OVER",rs:"RESTART",wipe:"WIPE?",sel:"Select Skill:",jc:"Job Change!",rank:"RANKING",sub:"SUBMIT SCORE",evt_atk:"Blacksmith refined weapon! +1 ATK",evt_matk:"Sage refined staff! +1 MATK",evt_hp:"Priest blessed you! +10 MaxHP"},
cn:{st:"Ë∫´ÂàÜÁôªÈåÑ",ph:"Ëº∏ÂÖ•ÂêçÁ®±",ea:"Á∞°ÂñÆ",ha:"Âõ∞Èõ£",mi:"‰ªªÂãô: ÈÅäÁé©‰ª•Ëß£ÈéñÁßòÂØÜ",on:"Ëá™Âãï:Èñã",off:"Ëá™Âãï:Èóú",lv:"Á≠âÁ¥ö",pts:"ÈªûÊï∏",ok:"Á¢∫Ë™ç",stb:"ÈñãÂßã",mvp:"MVPÂá∫Áèæ!",fi:"Êà∞È¨•",re:"‰ºëÊÅØ",nx:"‰∏ã‰∏ÄÂ±§",win:"ÂçÄÂüüÊ∏ÖÈô§",vic:"‰ªªÂãôÂÆåÊàê",go:"‰ªªÂãôÂ§±Êïó",rs:"Èáç‰æÜ",wipe:"Âà™Èô§Â≠òÊ™î?",sel:"ÈÅ∏ÊìáÊäÄËÉΩ:",jc:"ÂèØËΩâËÅ∑!",rank:"ÊéíË°åÊ¶ú",sub:"‰∏äÂÇ≥ÂàÜÊï∏",evt_atk:"ÈêµÂå†Á≤æÁÖâÊàêÂäü! +1 ATK",evt_matk:"Ë≥¢ËÄÖÂçáÁ¥öÊ≥ïÊùñ! +1 MATK",evt_hp:"ÁâßÂ∏´Á•ùÁ¶è! +10 HP‰∏äÈôê"}};

const K='jro_ultimate_v1';
const el=i=>document.getElementById(i);
const rnd=m=>Math.floor(Math.random()*m);
const H=t=>{let h=0;for(let i=0;i<t.length;i++)h=Math.imul(31,h)+t.charCodeAt(i)|0;return h.toString(16);}

const G={
    p:null, s:{f:1,b:false,tm:null,spd:10,au:false,l:'en'}, tmp:{g:'m'},
    
    init(){
        const r=localStorage.getItem(K);
        if(r){
            try{ const [d,h]=r.split('|'); if(H(d+SALT)!=h)throw new Error();
                const o=JSON.parse(atob(d)); this.p=o.p; this.s=o.s;
                if(!this.p.b) this.p.b = {atk:0,matk:0,hit:0,flee:0};
                this.s.b=false; clearInterval(this.s.tm);
                this.spd(this.s.spd); this.draw();
                if(this.p.pts>0&&!this.s.au) return this.stM(this.s.f==1);
                this.mnu();
            }catch(e){this.spd(10);this.scr();}
        }else{this.spd(10);this.scr();}
    },
    
    // --- RANKING ---
    openRank(){
        el('rank-ui').classList.remove('hide'); el('rank-list').innerHTML="Fetching...";
        fetch(RAW_URL + '?t=' + Date.now())
            .then(r=>r.json()).then(d=>{
                let h=""; d.forEach((r,i)=>{h+=`<div class="rank-row"><span style="color:${i<3?'#fd4':'#fff'}">#${i+1} ${r.n}</span><span class="c-d">${r.j}</span><span class="c-n">F${r.f}</span></div>`;});
                el('rank-list').innerHTML=h;
            }).catch(()=>el('rank-list').innerHTML="Offline");
    },
    closeRank(){el('rank-ui').classList.add('hide');},
    submitRank(){
        const now=Date.now(), last=localStorage.getItem('last_sub')||0;
        if(now-last<60000){alert("Wait 60s.");return;}
        localStorage.setItem('last_sub',now);
        const raw=`${this.p.n}-${this.p.j}-${this.s.f}-${SALT}`;
        let hash=0; for(let i=0;i<raw.length;i++){hash=((hash<<5)-hash)+raw.charCodeAt(i);hash|=0;}
        const d=JSON.stringify({n:this.p.n,j:this.p.j,f:this.s.f,h:hash.toString()});
        const title=encodeURIComponent(`SCORE: ${this.p.n}`);
        const body=encodeURIComponent("```json\n"+d+"\n```");
        window.open(`https://github.com/${GH_USER}/${GH_REPO}/issues/new?title=${title}&body=${body}`,'_blank');
    },

    // --- GAME SCREENS ---
    scr(){
        const c=el('ctl'); c.className='grid';
        window.setG=(g)=>{
            this.tmp.g=g; 
            el('bm').className=g=='m'?'g-tag m active':'g-tag m'; 
            el('bf').className=g=='f'?'g-tag f active':'g-tag f';
            el('spr').className=`spr ro-${g} j-0`;
        };
        c.innerHTML=`<div class="panel" style="grid-column:span 2;text-align:center">
        <div class="c-n" style="font-weight:bold;margin-bottom:10px">${this.txt('st')}</div>
        <div style="margin-bottom:10px;text-align:right"><button class="btn-sm" onclick="G.openRank()">üèÜ ${this.txt('rank')}</button></div>
        <div class="flex" style="justify-content:center;gap:5px;margin-bottom:15px;align-items:stretch">
            <input id="in" placeholder="${this.txt('ph')}" maxlength="10" style="flex-grow:1;text-align:left">
            <div id="bm" class="g-tag m active" onclick="setG('m')">_m</div>
            <div id="bf" class="g-tag f" onclick="setG('f')">_f</div>
        </div>
        <div class="grid g-2"><button onclick="G.ng(0)">${this.txt('ea')}</button><button class="btn-red" onclick="G.ng(1)">${this.txt('ha')}</button></div>
        <div style="font-size:9px;margin-top:10px;color:#464">${this.txt('mi')}</div></div>`;
        this.tmp.g='m';
        el('spr').className=`spr ro-m j-0`;
    },
    ng(d){
        const n=el('in').value||"Novice";
        this.p={n:n,j:0,lv:1,xp:0,nx:50,hp:60,mh:60,sp:20,ms:20,str:1,agi:1,vit:1,int:1,dex:1,luk:1,pts:5,pots:3,b:{atk:0,matk:0,hit:0,flee:0},eq:{w:null,a:null},sk:{},act:null,g:this.tmp.g};
        this.s={f:1,b:false,d:d,spd:10,au:false,l:this.s.l};
        this.skM();
    },
    skM(){
        this.sv(); el('ctl').innerHTML=''; this.log(this.txt('sel'),'l-w');
        SK0.forEach(s=>{ this.btn(`${this.s.l=='cn'?s.c:s.n}`,()=>{
            if(s.t!='h') this.p.act=s; this.p.sk[s.n]=1; this.stM(true);
        },'btn-blue'); });
    },
    stM(st){
        const c=el('ctl'); c.innerHTML=''; c.className='grid g-2';
        const d=document.createElement('div'); d.style.gridColumn='span 2'; d.className='c-n'; d.style.textAlign='center'; d.innerText=`${this.txt('pts')}: ${this.p.pts}`; c.appendChild(d);
        ['str','agi','vit','int','dex','luk'].forEach(k=>{
            this.btn(`${k.toUpperCase()} <span class="c-n">${this.p[k]}</span>`,()=>{
                if(this.p.pts>0){ this.p[k]++; this.p.pts--; this.draw(); this.stM(st); }
            },'btn-sm');
        });
        const b=document.createElement('button'); b.style.gridColumn='span 2'; b.innerText=st?this.txt('stb'):this.txt('ok');
        b.onclick=()=>{if(this.p.pts==0||!st){if(this.p.lv>=10&&this.p.j==0)this.jbM();else this.mnu();}}; c.appendChild(b);
    },
    jbM(){
        const c=el('ctl');c.innerHTML='';c.className='grid';
        for(let i=1;i<=6;i++) this.btn(this.s.l=='cn'?J[i].c:J[i].n,()=>{
            this.p.j=i; this.p.pts+=5; this.p.mh=J[i].hp+this.p.lv*20; this.p.hp=this.p.mh;
            const sn=J[i].n, l=SKJ[sn];
            if(l) l.forEach(s=>{ if(s.t!='h'&&s.t!='a')this.p.act=s; this.p.sk[s.n]=1; });
            this.mnu();
        });
    },
    mnu(){
        this.sv(); el('ctl').innerHTML=''; el('btl').classList.add('hide'); this.draw();
        
        if(this.s.au) {
            setTimeout(() => {
                if(this.s.f%10==0) this.bt(true);
                else this.bt(false);
            }, 500);
            return;
        }

        if(this.s.f%10==0 && this.s.f<=50){
            this.log(this.txt('mvp'),'c-h'); this.btn("BOSS",()=>this.bt(true),'btn-red'); return;
        }
        
        const loc=Math.min(5,Math.ceil(this.s.f/10)-1);
        const mn = this.s.f > 50 ? "Endless Tower" : (this.s.l=='cn'?LOC_CN[loc]:LOC_EN[loc]);
        this.log(`${mn} F${this.s.f}`);
        this.btn(this.txt('fi'),()=>this.bt(false));
        if(Math.random()<0.3) this.btn(this.txt('re'),()=>{this.p.hp=this.p.mh;this.draw();});
        if(this.s.f>1) el('ctl').innerHTML+=`<button class="btn-blue" style="width:100%;margin-top:5px" onclick="G.submitRank()">${this.txt('sub')}</button>`;
    },
    bt(isB){
        this.s.b=true; 
        const mScale = this.s.f > 50 ? Math.pow(1.05, this.s.f-50) : 1;
        const tier = Math.min(5, Math.ceil(this.s.f/10)-1);
        
        if(isB){
            const bIdx = this.s.f > 50 ? ((this.s.f/10)-1)%5 : (this.s.f/10)-1;
            const b = B[Math.min(4, bIdx)];
            const name = this.s.l=='cn'?b.c:b.n;
            this.mob = { n: this.s.f>50?name+" EX":name, h:b.h*mScale, a:b.a*mScale, x:b.x*mScale, agi:this.s.f*2, dex:this.s.f };
        } else {
            const mn = this.s.l=='cn'?MON_CN[tier]:MON_EN[tier];
            this.mob = { n:mn, h:this.s.f*25*mScale, a:(this.s.f*3+5)*mScale, x:this.s.f*10*mScale, agi:this.s.f, dex:this.s.f };
        }
        this.mob.hp=Math.floor(this.mob.h); this.mob.mh=this.mob.hp;
        this.pb=0; this.eb=0;
        el('btl').classList.remove('hide'); el('ctl').innerHTML=''; el('en').innerText=this.mob.n;
        if(this.s.tm)clearInterval(this.s.tm); this.s.tm=setInterval(()=>this.tk(),30);
    },
    tk(){
        const ps=this.calc(this.p), es=3+(this.mob.agi*0.1);
        this.pb+=ps.aspd; this.eb+=es;
        if(this.pb>=1000){this.pb=0;this.act(this.p,this.mob,ps,true);}
        if(this.eb>=1000){this.eb=0;this.act(this.mob,this.p,{hit:999,crit:0,atk:this.mob.a},false);}
        if(this.s.b){el('ap').value=this.pb;el('ae').value=this.eb;el('eh').innerText=this.mob.hp;}
    },
    calc(c){
        const j=J[c.j]||J[0], b=c.b, eq=c.eq.w?.v||0;
        let atk=c.str+Math.floor(c.dex/5)+Math.floor(c.luk/3)+c.lv*2+b.atk+eq;
        let matk=c.int+Math.floor(c.int/2)+Math.floor(c.dex/5)+c.lv*2+b.matk+eq;
        let aspd=Math.floor((j.as||50)+(c.agi*0.8)+(c.dex*0.2)+b.atk);
        let hit=c.dex+c.lv+b.hit, flee=c.agi+c.lv+b.flee, crit=1+(c.luk*0.3);
        if(c.sk['Quicken']) aspd+=5; if(c.sk['Hiding']) flee+=15; if(c.sk['Double']) crit+=5;
        return {atk,matk,aspd,hit,flee,crit,def:Math.floor(c.vit/2)+Math.floor(c.lv/2)};
    },
    act(s,t,st,p){
        let sk=p?this.p.act:null, type=sk?sk.t:'p', mul=sk?sk.v:1;
        let hit=type=='m'?100:(80+st.hit-(t.agi||0)), cr=p?(Math.random()*100<st.crit):false;
        if(Math.random()*100>hit){if(this.s.spd<20)this.log("Miss","l-miss");return;}
        let d = type=='m' ? st.matk*mul : Math.max(1, (st.atk*mul*(cr?1.5:1)) - (p?0:st.def));
        t.hp -= Math.floor(d);
        if(this.s.spd<20||cr||t.hp<=0) this.log(`${Math.floor(d)}${cr?'!':''}`, p?(cr?'l-crit':'l-dmg'):'l-dmg');
        if(p&&this.p.hp<this.p.mh*0.3&&this.p.pots>0){this.p.pots--;this.p.hp+=Math.floor(this.p.mh*0.5);}else if(!p)this.draw();
        if(t.hp<=0){if(p)this.win();else this.over();}
    },
    win(){
        clearInterval(this.s.tm); this.s.b=false; el('btl').classList.add('hide');
        this.p.xp+=this.mob.x;
        
        // --- RANDOM EVENTS ---
        if(Math.random() < 0.3) {
            const r = rnd(3);
            if(r==0){ this.p.b.atk++; this.log(this.txt('evt_atk'),'c-r'); }
            else if(r==1){ this.p.b.matk++; this.log(this.txt('evt_matk'),'c-r'); }
            else { this.p.mh+=10; this.p.hp+=10; this.log(this.txt('evt_hp'),'c-r'); }
        }

        if(Math.random()<0.1) {
            const type=rnd(2)?'w':'a', pl=DB.items[type], tr=Math.min(pl.length-1,Math.floor(this.s.f/8)), it=pl[tr];
            if(!this.p.eq[type]||it.v>this.p.eq[type].v){
                if(type=='a'){if(this.p.eq.a)this.p.mh-=this.p.eq.a.v;this.p.mh+=it.v;this.p.hp=this.p.mh;}
                this.p.eq[type]=it; this.log(`GET ${it.n}`,'c-n');
            }
        }
        if(this.p.xp>=this.p.nx){
            this.p.lv++; this.p.xp=0; this.p.nx=Math.floor(this.p.nx*1.5);
            this.p.pts+=3; this.p.mh+=20; this.p.hp=this.p.mh;
            if(this.s.au){this.autoDist();this.mnu();}else this.stM(false);
        }else{ if(this.s.f%10==0)this.s.f++; this.mnu(); }
    },
    over(){clearInterval(this.s.tm);this.s.b=false;localStorage.removeItem(K);el('ctl').innerHTML=`<div class="panel" style="text-align:center"><div class="c-h">GAME OVER</div><button onclick="G.scr()">${this.txt('rs')}</button></div>`;},
    
    // --- HELPERS ---
    txt(k){return T[this.s.l][k]||k},
    log(t,c=''){const l=el('log');l.insertAdjacentHTML('afterbegin',`<div class="lr ${c}">${t}</div>`);if(l.children.length>20)l.lastChild.remove();},
    btn(t,fn,c=''){const b=document.createElement('button');b.innerHTML=t;b.onclick=fn;if(c)b.className=c;el('ctl').appendChild(b);},
    draw(){
        const p=this.p, s=el('spr'), src=p||this.tmp;
        s.className='spr'; s.classList.add(`ro-${src.g}`, `j-${p?Math.min(6,p.j):0}`);
        if(!p)return;
        el('un').innerText=p.n; el('uj').innerText=this.s.l=='cn'?J[p.j].c:J[p.j].n; el('ul').innerText=p.lv; el('ulo').innerText=`F${this.s.f}`;
        ['str','agi','vit','int','dex','luk'].forEach(k=>el('v'+k).innerText=p[k]);
        el('bh').value=p.hp; el('bh').max=p.mh; el('uh').innerText=p.hp;
        el('bs').value=p.sp; el('bs').max=20; el('us').innerText=p.sp; 
        el('b-au').innerText=this.s.au?(this.s.l=='cn'?'Ëá™Âãï:Èñã':'AUTO:ON'):(this.s.l=='cn'?'Ëá™Âãï:Èóú':'AUTO:OFF');
        el('b-au').classList.toggle('active',this.s.au);
    },
    autoDist(){
        while(this.p.pts>0){const k=['str','agi','vit','int','dex','luk'][rnd(6)];this.p[k]++;this.p.pts--;if(k=='vit'){this.p.mh+=20;this.p.hp+=20;}}
        this.draw(); 
    },
    tAu(){this.s.au=!this.s.au;this.draw();if(this.s.au&&this.p.pts>0){this.autoDist();this.draw();if(el('ctl').innerText.includes('PTS'))this.mnu();}},
    lang(){this.s.l=this.s.l=='en'?'cn':'en';this.draw();if(!this.p)this.scr();},
    sv(){const d=btoa(JSON.stringify({p:this.p,s:this.s}));localStorage.setItem(K,d+"|"+H(d+SALT));},
    wipe(){if(confirm(this.txt('wipe'))){localStorage.removeItem(K);location.reload();}},
    spd(x){this.s.spd=x;document.querySelectorAll('.flex button').forEach(b=>b.classList.remove('active'));const b=el('s'+x);if(b)b.classList.add('active');},
    exp(){this.sv();const a=document.createElement('a');a.href="data:text/plain;charset=utf-8,"+encodeURIComponent(localStorage.getItem(K));a.download=`JRO_${this.p.n}.sav`;document.body.appendChild(a);a.click();a.remove();},
    imp(el){const f=el.files[0];if(!f)return;const r=new FileReader();r.onload=e=>{try{const raw=e.target.result;const [d,h]=raw.split('|');if(H(d+SALT)!=h)throw new Error();localStorage.setItem(K,raw);location.reload();}catch(e){alert(this.txt('err'))}};r.readAsText(f);}
};

// Item DB (Hidden)
const DB={items:{w:[{n:'Knife',v:5},{n:'Blade',v:15},{n:'Katana',v:25},{n:'Saber',v:40},{n:'Muramasa',v:70},{n:'Excalibur',v:100}],a:[{n:'Shirt',v:10},{n:'Jacket',v:20},{n:'Coat',v:50},{n:'Mail',v:90},{n:'Plate',v:150},{n:'Suit',v:250}]}};

G.init();
</script>
</body>
</html>