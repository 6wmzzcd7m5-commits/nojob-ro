<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Jobless RO: Balanced</title>
<style>
    :root { --bg:#050505; --p:#0a0f0a; --bd:#333; --n:#39ff14; --t:#eef; --d:#686; --hp:#f44; --sp:#4af; --r:#fd4; --font:'Courier New',mono; --m:#4af; --f:#f4a; }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent;user-select:none}
    body{background:var(--bg);color:var(--t);font-family:var(--font);margin:0 auto;padding:10px;max-width:500px;height:100vh;display:flex;flex-direction:column;gap:8px;overflow:hidden}
    .flex{display:flex;justify-content:space-between;align-items:center}.grid{display:grid;gap:5px}.g-2{grid-template-columns:1fr 1fr}.g-6{grid-template-columns:repeat(6,1fr)}
    .c-n{color:var(--n)}.c-h{color:var(--hp)}.c-s{color:var(--sp)}.c-d{color:var(--d)}
    .panel{border:1px solid var(--bd);background:var(--p);padding:8px;border-radius:4px}.hide{display:none!important}
    button{background:#0d1a0d;color:var(--n);border:1px solid #141;padding:10px;font:inherit;font-weight:bold;cursor:pointer;border-radius:2px}
    button:active,button.active{background:#163016;color:#fff;border-color:#fff}
    .btn-sm{padding:4px 8px;font-size:10px}.btn-red{border-color:#522;color:#f55;background:#211}.btn-blue{border-color:#225;color:#55f;background:#112}
    input{background:#000;border:1px solid var(--n);color:#fff;padding:8px;width:100%;font:inherit}
    .g-tag{padding:8px 12px;border:1px solid #333;cursor:pointer;color:#555;font-weight:bold;background:#000;transition:0.2s}
    .g-tag.m.active{color:var(--m);border-color:var(--m);text-shadow:0 0 5px var(--m)}.g-tag.f.active{color:var(--f);border-color:var(--f);text-shadow:0 0 5px var(--f)}
    progress{width:100%;height:6px;appearance:none;border:none;background:#111;display:block}
    progress::-webkit-progress-bar{background:#111}progress::-webkit-progress-value{transition:width 0.1s linear}
    #bh::-webkit-progress-value{background:var(--hp)}#bs::-webkit-progress-value{background:var(--sp)}#ap::-webkit-progress-value{background:var(--n)}#ae::-webkit-progress-value{background:var(--hp)}
    #log{flex:1;overflow-y:auto;font-size:11px;border-top:1px solid var(--bd);padding-top:5px;display:flex;flex-direction:column-reverse}
    .lr{border-bottom:1px solid #111;padding:2px 0}.l-w{color:var(--n)}.l-l{color:var(--r)}
    /* Pixel Engine */
    .cf{width:40px;height:40px;position:relative;overflow:hidden;border:1px solid #242;background:#000;border-radius:4px;margin-right:10px;flex-shrink:0}
    .spr{position:absolute;top:8px;left:10px;width:20px;height:30px;animation:i 1s infinite steps(2)}
    .hd{width:14px;height:12px;background:#fca;position:absolute;left:3px;top:0;z-index:5;border-radius:2px}
    .hd::after{content:'';position:absolute;top:5px;left:3px;width:2px;height:2px;background:#000;box-shadow:6px 0 0 #000}
    .hr{width:16px;height:7px;background:#853;position:absolute;left:2px;top:-2px;z-index:6}
    .ro-m .hr{border-radius:4px 4px 0 0}.ro-f .hr{width:18px;left:1px;border-radius:8px 8px 0 0;height:8px}
    .ro-f .hr::after{content:'';position:absolute;top:5px;left:-2px;width:3px;height:12px;background:inherit;box-shadow:19px 0 0 inherit}
    .bd{width:12px;height:11px;background:#eee;position:absolute;left:4px;top:11px;z-index:2;border-radius:3px 3px 0 0}
    .bd::after{content:'';position:absolute;top:11px;left:1px;width:4px;height:4px;background:#fca;box-shadow:6px 0 0 #fca}
    @keyframes i{0%,100%{transform:translateY(0)}50%{transform:translateY(1px)}}
    .j-0 .bd{background:linear-gradient(to bottom,#fff 60%,#dca 60%)}.j-0 .bd::after{background:#a86;box-shadow:6px 0 0 #a86}
    .j-1 .bd{background:linear-gradient(to bottom,#d84 50%,#468 50%);border-top:2px solid #b62;width:14px;left:3px}.j-1 .bd::after{background:#532;box-shadow:6px 0 0 #532}
    .j-2 .bd{background:linear-gradient(90deg,#348 20%,#eee 20%,#eee 80%,#348 80%);border-bottom:3px solid #642}.j-2 .bd::after{background:#333;box-shadow:6px 0 0 #333}
    .j-3 .bd{background:linear-gradient(to bottom,#637 40%,#fca 40%,#fca 60%,#543 60%)}.j-3 .bd::after{background:#543;box-shadow:6px 0 0 #543}
    .j-4 .bd{background:linear-gradient(to bottom,#473 60%,#db9 60%);border-left:2px solid #fca;border-right:2px solid #fca;width:14px;left:3px}.j-4 .bd::after{background:#432;box-shadow:6px 0 0 #432}
    .j-5 .bd{background:linear-gradient(90deg,#fff 40%,#d44 40%,#d44 60%,#fff 60%);border-bottom:2px solid #b86}.j-5 .bd::after{background:#333;box-shadow:6px 0 0 #333}
    .j-6 .bd{background:linear-gradient(90deg,#eee 30%,#a44 30%,#a44 70%,#eee 70%);border-bottom:2px solid #334}.j-6 .bd::after{background:#eee;box-shadow:6px 0 0 #eee;height:5px}
    .stc{text-align:center;font-size:10px;border-top:1px dashed #242;padding-top:4px}.stv{font-size:12px;font-weight:bold;color:#fff;display:block}
</style>
</head>
<body>
<header class="panel grid">
    <div class="flex" style="border-bottom:1px dashed #242;padding-bottom:5px">
        <div class="flex" style="gap:5px">
            <button class="btn-sm btn-red" onclick="G.wipe()">[R]</button>
            <button class="btn-sm btn-blue" onclick="G.save()">[S]</button>
            <button class="btn-sm" onclick="G.lang()">EN/中</button>
            <button id="b-au" class="btn-sm" onclick="G.tAu()">AUTO</button>
        </div>
        <div class="flex" style="gap:2px"><button class="btn-sm" id="s10" onclick="G.spd(10)">1X</button><button class="btn-sm" id="s30" onclick="G.spd(30)">3X</button><button class="btn-sm" id="s99" onclick="G.spd(99)">MAX</button></div>
    </div>
    <div class="flex" style="justify-content:flex-start">
        <div class="cf"><div id="spr" class="spr ro-m"><div class="hr"></div><div class="hd"></div><div class="bd"></div></div></div>
        <div style="flex-grow:1">
            <div class="flex"><div><b id="un" class="c-n"></b> <span id="uj" class="c-d" style="font-size:10px"></span></div><div style="font-size:11px">LV <span id="ul" class="c-r">1</span></div></div>
            <div class="c-n" style="font-size:10px;margin-top:2px" id="ulo"></div>
        </div>
    </div>
    <div class="grid g-2">
        <div style="font-size:10px"><div class="flex"><span>HP</span> <span id="uh"></span></div><progress id="bh" value="100" max="100"></progress></div>
        <div style="font-size:10px"><div class="flex"><span>SP</span> <span id="us"></span></div><progress id="bs" value="20" max="20"></progress></div>
    </div>
    <div class="flex c-d" style="font-size:10px"><span>W: <b id="uw" class="c-n">-</b></span><span>A: <b id="ua" class="c-n">-</b></span></div>
    <div class="grid g-6">
        <div class="stc"><span class="c-d">STR</span><span id="vstr" class="stv">1</span></div><div class="stc"><span class="c-d">AGI</span><span id="vagi" class="stv">1</span></div><div class="stc"><span class="c-d">VIT</span><span id="vvit" class="stv">1</span></div>
        <div class="stc"><span class="c-d">INT</span><span id="vint" class="stv">1</span></div><div class="stc"><span class="c-d">DEX</span><span id="vdex" class="stv">1</span></div><div class="stc"><span class="c-d">LUK</span><span id="vluk" class="stv">1</span></div>
    </div>
</header>
<section id="btl" class="panel hide">
    <div class="flex"><span id="en" style="font-weight:bold;color:var(--hp)">TARGET</span> <span id="eh" class="c-d" style="font-size:10px"></span></div>
    <div class="grid" style="margin-top:5px">
        <div class="flex" style="font-size:10px"><span class="c-n">ATB</span> <progress id="ap" value="0" max="1000" style="width:85%"></progress></div>
        <div class="flex" style="font-size:10px"><span class="c-h">FOE</span> <progress id="ae" value="0" max="1000" style="width:85%"></progress></div>
    </div>
</section>
<nav id="ctl" class="grid g-2" style="min-height:60px"></nav>
<main id="log"></main>
<script>
// --- DATABASE ---
const J=[{n:'Novice',c:'初心者',hp:60,sp:20,as:50},{n:'Swordman',c:'劍士',hp:150,sp:40,as:45},{n:'Mage',c:'法師',hp:80,sp:120,as:60},{n:'Thief',c:'盜賊',hp:110,sp:50,as:35},{n:'Archer',c:'弓箭手',hp:100,sp:60,as:40},{n:'Acolyte',c:'服事',hp:90,sp:100,as:55},{n:'Merchant',c:'商人',hp:120,sp:50,as:50}];
const B=[{n:'Angeling',c:'天使波利',hp:1500,a:50,x:1000},{n:'GT Bug',c:'黃金蟲',hp:5000,a:120,x:3500},{n:'Eddga',c:'虎王',hp:12000,a:250,x:12000},{n:'Osiris',c:'歐西里斯',hp:30000,a:600,x:40000},{n:'Baphomet',c:'巴風特',hp:99999,a:1500,x:99999}];
const LOC_EN=["Prontera","Payon","Orc Dungeon","Glast Heim","Clock Tower","Thanatos"];
const LOC_CN=["普隆德拉","斐揚","獸人洞穴","古城","鐘塔","塔納托斯"];
const MON_EN=["Poring","Wolf","Orc","Raydric","Alarm","Thanatos"];
const MON_CN=["波利","狼","獸人","深淵騎士","朽魔","塔納托斯"];

// Skill Types: p=phys, m=mag, h=heal, a=passive
// Balanced: Magic has higher multipliers (no crit), Phys has lower (has crit)
const SK0=[{n:'First Aid',c:'緊急治療',v:20,t:'h'},{n:'Bash',c:'狂擊',v:1.4,t:'p'},{n:'Napalm',c:'心靈爆破',v:1.5,t:'m'}];
const SKJ={
    Swordman:[{n:'Bash',c:'狂擊',v:1.5,t:'p'},{n:'Magnum',c:'怒爆',v:1.2,t:'p'},{n:'Berserk',c:'狂暴',t:'a'}],
    Mage:[{n:'FireBolt',c:'火箭術',v:2.0,t:'m'},{n:'ColdBolt',c:'冰箭術',v:2.0,t:'m'},{n:'Lightning',c:'雷擊術',v:2.0,t:'m'}],
    Thief:[{n:'Envenom',c:'施毒',v:1.5,t:'p'},{n:'Double',c:'二刀連擊',t:'a'},{n:'Hiding',c:'偽裝',t:'a'}],
    Acolyte:[{n:'HolyLight',c:'神聖之光',v:1.8,t:'m'},{n:'Heal',c:'治癒術',v:50,t:'h'},{n:'Divine',c:'天使之護',t:'a'}],
    // 2nd Jobs simulated via high multipliers
    Knight:[{n:'BowlBash',c:'怪物互擊',v:3.5,t:'p'},{n:'Pierce',c:'連刺',v:2.5,t:'p'},{n:'Quicken',c:'加速',t:'a'}],
    Wizard:[{n:'StormGust',c:'暴風雪',v:4.5,t:'m'},{n:'Meteor',c:'隕石術',v:4.5,t:'m'},{n:'Vermilion',c:'怒雷',v:5.0,t:'m'}],
    Assassin:[{n:'SonicBlow',c:'音速投擲',v:3.0,t:'p'},{n:'Grimtooth',c:'無影之牙',v:2.5,t:'p'},{n:'Katar',c:'拳刃修練',t:'a'}]
};

const T={en:{st:"ID REGISTRATION",ph:"NAME",ea:"EASY",ha:"HARD",mi:"MISSION: 打爆機睇AB食雞子相",on:"AUTO:ON",off:"AUTO:OFF",lv:"LV",w:"W",a:"A",foe:"FOE",pts:"PTS",ok:"OK",stb:"START",mvp:"MVP DETECTED!",fi:"FIGHT",re:"REST",nx:"NEXT FLOOR",win:"CLEARED",lo:"LOOT",eq:"Equipped!",vic:"VICTORY",go:"GAME OVER",rs:"RESTART",wipe:"WIPE?",sel:"Select Skill:",jc:"Job Change!",ref:"Refined",bl:"Blessed",gd:"GENDER",m:"MALE",f:"FEMALE",sv:"Saved",ld:"Loaded",err:"Corrupt"},
cn:{st:"身分登錄",ph:"名稱",ea:"簡單",ha:"困難",mi:"任務: 打爆機睇AB食雞子相",on:"自動:開",off:"自動:關",lv:"等級",w:"武",a:"防",foe:"敵",pts:"點數",ok:"確認",stb:"開始",mvp:"MVP出現!",fi:"戰鬥",re:"休息",nx:"下一層",win:"區域清除",lo:"掉落",eq:"已裝備!",vic:"任務完成",go:"任務失敗",rs:"重來",wipe:"刪除存檔?",sel:"選擇技能:",jc:"可轉職!",ref:"精煉",bl:"祝福",gd:"性別",m:"男",f:"女",sv:"已存檔",ld:"讀取成功",err:"存檔損毀"}};

const K='jro_bal_v1', S='ROX'; 
const el=i=>document.getElementById(i);
const rnd=m=>Math.floor(Math.random()*m);
const H=t=>{let h=0;for(let i=0;i<t.length;i++)h=Math.imul(31,h)+t.charCodeAt(i)|0;return h.toString(16);}

const G={
    p:null, s:{f:1,b:false,tm:null,spd:10,au:false,fk:0,l:'en'}, tmp:{n:"",g:"m"},
    txt(k){return T[this.s.l][k]||k},
    dn(o){if(!o)return"-";return this.s.l=='cn'?(o.c||o.n_cn||o.n):o.n},
    dm(id){return this.s.l=='cn'?LOC_CN[id]:LOC_EN[id]},

    init(){
        const r=localStorage.getItem(K);
        if(r){
            try{ const [d,h]=r.split('|'); if(H(d+S)!=h)throw new Error();
                const o=JSON.parse(atob(d)); this.p=o.p; this.s=o.s;
                this.s.b=false; clearInterval(this.s.tm);
                this.spd(this.s.spd); this.draw();
                if(this.p.pts>0&&!this.s.au) return this.stM(this.s.f==1);
                this.mnu();
            }catch(e){this.spd(10);this.scr();}
        }else{this.spd(10);this.scr();}
    },
    sv(){const d=btoa(JSON.stringify({p:this.p,s:this.s}));localStorage.setItem(K,d+"|"+H(d+S));},
    wipe(){if(confirm(this.txt('wipe'))){localStorage.removeItem(K);location.reload();}},
    
    // --- CORE STATS ---
    calc(c){
        const j=J[c.j], b=c.b, eq=c.eq.w?.v||0;
        // Base Stats
        let atk = c.str + Math.floor(c.dex/5) + Math.floor(c.luk/3) + Math.floor(c.lv*2) + b.atk + eq;
        let matk = c.int + Math.floor(c.int/2) + Math.floor(c.dex/5) + Math.floor(c.lv*2) + b.matk + eq;
        let aspd = Math.floor(j.as + (c.agi*0.8) + (c.dex*0.2) + b.atk); // DEX helps cast/aspd
        let hit = c.dex + c.lv + b.hit;
        let flee = c.agi + c.lv + b.flee;
        let crit = 1 + (c.luk*0.3);
        let def = Math.floor(c.vit/2) + Math.floor(c.lv/2);
        
        // Passives
        if(c.sk['Hiding']||c.sk['Quicken']) flee+=15;
        if(c.sk['Katar']) crit+=10;
        if(c.sk['Quicken']) aspd+=5;
        if(c.sk['Berserk'] && c.hp<c.mh*0.25) atk+=c.lv*2;
        if(c.sk['Double']) crit+=5; // Simulates double hit dps increase via crit chance

        return {atk, matk, aspd, hit, flee, crit, def};
    },
    
    // --- BATTLE LOGIC ---
    act(src, tgt, st, isP){
        // 1. Determine Attack Type (Skill or Normal)
        let skill = null;
        if(isP && this.p.activeSkill) skill = this.p.activeSkill; // Currently equipped active skill
        
        const type = skill ? skill.t : 'p'; // Default to phys
        const mult = skill ? skill.v : 1.0;

        // 2. Hit Check
        // Magic always hits. Phys checks HIT vs FLEE (80% base)
        let hitChance = (type=='m') ? 100 : (80 + st.hit - tgt.agi);
        if(Math.random()*100 > hitChance){ if(this.s.spd<20)this.log("Miss!"); return; }

        // 3. Damage Calc
        let dmg = 0;
        let isCrit = false;

        if(type === 'm') {
            // Magic: Uses MATK, Ignores DEF (Pierce)
            dmg = st.matk * mult;
        } else {
            // Phys: Uses ATK, Checks DEF, Can Crit
            isCrit = (Math.random()*100 < st.crit);
            dmg = st.atk * mult;
            if(isCrit) dmg = Math.floor(dmg * 1.5);
            else dmg = Math.max(1, dmg - (isP ? (tgt.vit/2) : st.def)); // Simple DEF deduction
        }

        // 4. Apply Damage
        dmg = Math.floor(dmg * (Math.random()*0.2 + 0.9)); // Variance
        tgt.hp -= dmg;

        // 5. Log
        if(this.s.spd<20 || isCrit || tgt.hp<=0){
            let sName = skill ? (this.s.l=='cn'?skill.c:skill.n) : "";
            this.log(`${sName} ${dmg} ${isCrit?'CRIT!':''}`);
        }

        // 6. Potion / Win Condition
        if(isP && this.p.hp < this.p.mh*0.3 && this.p.pots>0){
            this.p.pots--; this.p.hp+=Math.floor(this.p.mh*0.5); this.log("Potion!",'c-s');
        } else if(!isP) this.draw();

        if(tgt.hp<=0){ if(isP) this.win(); else this.over(); }
    },

    // --- GAME LOOP ---
    tick(){
        const ps=this.calc(this.p); const es=3+(this.mob.agi*0.1);
        this.pb+=ps.aspd; this.eb+=es;
        if(this.pb>=1000){this.pb=0;this.act(this.p,this.mob,ps,true);}
        if(this.eb>=1000){this.eb=0;this.act(this.mob,this.p,{hit:999,crit:0,atk:this.mob.a,matk:0},false);}
        if(this.s.b){el('ap').value=this.pb;el('ae').value=this.eb;el('eh').innerText=this.mob.hp;}
    },
    
    // --- MOBS & ITEMS ---
    genMob(f,isB){
        if(isB){
            const i=(f/10)-1; const b=B[i];
            return { n:this.s.l=='cn'?b.c:b.n, hp:b.hp, max:b.hp, atk:b.a, xp:b.x, agi:f*2, dex:f*2, vit:f*5 };
        }
        const t=Math.min(5,Math.ceil(f/10)-1);
        const name=this.s.l=='cn'?MON_CN[t]:MON_EN[t];
        return { n:name, hp:f*25, max:f*25, atk:f*3+5, xp:f*10, agi:f, dex:f, vit:f };
    },
    
    // --- SCREENS ---
    scr(){
        const c=el('ctl'); c.className='grid';
        window.setG=(g)=>{this.tmp.g=g;el('bm').className=g=='m'?'g-tag m active':'g-tag';el('bf').className=g=='f'?'g-tag f active':'g-tag';this.draw();};
        c.innerHTML=`<div class="panel" style="grid-column:span 2;text-align:center"><div class="c-n" style="font-weight:bold">${this.txt('st')}</div>
        <div class="flex" style="justify-content:center;gap:10px;margin:15px 0"><div class="cf"><div id="spr" class="spr ro-m"><div class="hr"></div><div class="hd"></div><div class="bd"></div></div></div><div style="flex:1"><input id="in" placeholder="${this.txt('ph')}" maxlength="10" style="margin:0"></div><div id="bm" class="g-tag m active" onclick="setG('m')">_m</div><div id="bf" class="g-tag f" onclick="setG('f')">_f</div></div>
        <div class="grid g-2"><button onclick="G.ng(0)">EASY</button><button class="btn-red" onclick="G.ng(1)">HARD</button></div></div>`;
        this.tmp.g='m'; this.draw();
    },
    ng(d){
        const n=el('in').value||"Novice";
        this.p={n:n,j:0,lv:1,xp:0,nx:50,hp:60,mh:60,sp:20,ms:20,str:1,agi:1,vit:1,int:1,dex:1,luk:1,pts:5,pots:3,b:{atk:0,matk:0,hit:0,flee:0},eq:{w:null,a:null},sk:{},activeSkill:null,g:this.tmp.g};
        this.s={f:1,b:false,d:d,spd:10,au:false,l:this.s.l};
        this.skM();
    },
    skM(){
        this.sv(); el('ctl').innerHTML=''; this.log(this.txt('sel'),'l-w');
        SK0.forEach(s=>{ this.btn(`${this.s.l=='cn'?s.c:s.n}`,()=>{
            if(s.t!='h') this.p.activeSkill = s; // Set active attack skill
            this.p.sk[s.n]=1; this.stM(true);
        },'btn-blue'); });
    },
    stM(st){
        const c=el('ctl'); c.innerHTML=''; c.className='grid g-2';
        const d=document.createElement('div'); d.style.gridColumn='span 2'; d.className='c-n'; d.style.textAlign='center'; d.innerText=`PTS: ${this.p.pts}`; c.appendChild(d);
        ['str','agi','vit','int','dex','luk'].forEach(k=>{
            this.btn(`${k.toUpperCase()} <span class="c-n">${this.p[k]}</span>`,()=>{
                if(this.p.pts>0){ this.p[k]++; this.p.pts--; this.draw(); this.stM(st); }
            },'btn-sm');
        });
        const b=document.createElement('button'); b.style.gridColumn='span 2'; b.innerText=st?'START':'OK';
        b.onclick=()=>{ if(this.p.pts==0 || !st){ 
            if(this.p.lv>=10 && this.p.j==0) this.jobM(); else if(this.p.lv>=40 && this.p.j>0 && this.p.j<=6) this.jobM(); else this.mnu();
        }}; c.appendChild(b);
    },
    jobM(){
        const c=el('ctl'); c.innerHTML=''; c.className='grid';
        this.log("Job Change!");
        // If Novice (0), show 1st jobs (1-6). If 1st job, show specific 2nd job.
        if(this.p.j==0){
            for(let i=1;i<=6;i++) this.btn(this.s.l=='cn'?J[i].c:J[i].n,()=>this.setJob(i));
        } else {
            // Simplified: 1->7(Knight), 2->9(Wizard), 3->15(Assassin) etc based on DB order
            // Mapping: Sword(1)->Knight(7), Mage(2)->Wiz(9), Thief(3)->Ass(15), Archer(4)->Hunt(11), Aco(5)->Priest(17), Merch(6)->BS(13)
            const map={1:7,2:9,3:15,4:11,5:17,6:13};
            const nid = map[this.p.j];
            this.btn(this.s.l=='cn'?J[nid].c:J[nid].n,()=>this.setJob(nid));
        }
    },
    setJob(id){
        this.p.j=id; this.p.pts+=5; 
        this.p.mh=J[id].hp+this.p.lv*20; this.p.hp=this.p.mh;
        // Select Skill for new job
        const jobName = J[id].n; 
        // Note: Array mapping for SKJ needs direct name lookup or simple case
        // Simple hack for this procedural version:
        let list = SKJ[jobName] || [];
        if(list.length>0){
            el('ctl').innerHTML='';
            list.forEach(s=>{ this.btn(`${this.s.l=='cn'?s.c:s.n}`,()=>{
                if(s.t!='h' && s.t!='a') this.p.activeSkill = s;
                this.p.sk[s.n]=1; this.mnu();
            },'btn-blue'); });
        } else { this.mnu(); }
    },
    win(){
        clearInterval(this.s.tm); this.s.b=false; el('btl').classList.add('hide');
        this.p.xp += this.mob.xp;
        if(Math.random()<0.3){ 
            if(Math.random()<0.5) this.p.b.atk++; else this.p.mh++;
            this.log("Bonus Stat",'c-n');
        }
        if(this.p.xp >= this.p.nx){
            this.p.lv++; this.p.xp=0; this.p.nx=Math.floor(this.p.nx*1.5);
            this.p.pts+=3; this.p.mh+=20; this.p.hp=this.p.mh;
            this.log("LEVEL UP!",'l-w');
            if(this.s.au){ this.autoDist(); this.mnu(); } else { this.stM(false); }
        } else {
            if(this.s.f%10==0) this.s.f++; this.mnu();
        }
    },
    mnu(){
        this.sv(); el('ctl').innerHTML=''; el('btl').classList.add('hide'); this.draw();
        if(this.s.f>50){ this.vic(); return; }
        if(this.s.f%10==0){
            this.log("BOSS!",'c-h'); this.btn("BOSS",()=>this.battle(true),'btn-red');
        } else {
            const loc=Math.min(5,Math.ceil(this.s.f/10)-1);
            this.log(`${this.s.l=='cn'?LOC_CN[loc]:LOC_EN[loc]} F${this.s.f}`);
            this.btn("FIGHT",()=>this.battle(false));
            if(Math.random()<0.3) this.btn("REST",()=>{this.p.hp=this.p.mh;this.draw();});
        }
    },
    battle(isB){
        this.s.b=true; this.mob=this.genMob(this.s.f, isB);
        this.pb=0; this.eb=0;
        el('btl').classList.remove('hide'); el('ctl').innerHTML='';
        el('en').innerText=this.mob.n;
        if(this.s.tm)clearInterval(this.s.tm); this.s.tm=setInterval(()=>this.tick(),30);
    },
    over(){
        clearInterval(this.s.tm); this.s.b=false; localStorage.removeItem(K);
        el('ctl').innerHTML=`<div class="panel" style="text-align:center"><div class="c-h">GAME OVER</div><button onclick="G.scr()">RESTART</button></div>`;
    },
    vic(){el('ctl').innerHTML=`<div class="panel" style="text-align:center"><div class="l-w">VICTORY</div><button onclick="G.scr()">NEW GAME</button></div>`;},
    
    // --- HELPERS ---
    log(t,c=''){const l=el('log');l.insertAdjacentHTML('afterbegin',`<div class="lr ${c}">${t}</div>`);if(l.children.length>20)l.lastChild.remove();},
    btn(t,fn,c=''){const b=document.createElement('button');b.innerHTML=t;b.onclick=fn;if(c)b.className=c;el('ctl').appendChild(b);},
    draw(){
        const p=this.p, s=el('spr'), src=p||this.tmp;
        s.className='spr'; s.classList.add(`ro-${src.g}`, `j-${p?Math.min(6,p.j):0}`);
        if(!p)return;
        el('un').innerText=p.n; el('uj').innerText=this.s.l=='cn'?J[p.j].c:J[p.j].n; el('ul').innerText=p.lv;
        const loc=Math.min(5,Math.ceil(this.s.f/10)-1); el('ulo').innerText=`${this.s.l=='cn'?LOC_CN[loc]:LOC_EN[loc]} ${this.s.f}F`;
        ['str','agi','vit','int','dex','luk'].forEach(k=>el('v'+k).innerText=p[k]);
        el('bh').value=p.hp; el('bh').max=p.mh; el('uh').innerText=p.hp;
        el('bs').value=p.sp; el('bs').max=p.ms; el('us').innerText=p.sp;
        el('b-au').innerText=this.s.au?(this.s.l=='cn'?'自動:開':'AUTO:ON'):(this.s.l=='cn'?'自動:關':'AUTO:OFF');
        el('b-au').classList.toggle('active',this.s.au);
    },
    autoDist(){
        while(this.p.pts>0){
            const k=['str','agi','vit','int','dex','luk'][rnd(6)];
            this.p[k]++; this.p.pts--;
            if(k=='vit'){this.p.mh+=20;this.p.hp+=20;}
        }
    },
    tAu(){this.s.au=!this.s.au;this.draw();if(this.s.au&&this.p.pts>0){this.autoDist();this.draw();if(el('ctl').innerText.includes('PTS'))this.mnu();}},
    lang(){this.s.l=this.s.l=='en'?'cn':'en';this.draw();if(!this.p)this.scr();},
    spd(x){this.s.spd=x;document.querySelectorAll('.flex button').forEach(b=>b.classList.remove('active'));const b=el('s'+x);if(b)b.classList.add('active');},
};
G.init();
</script>
</body>
</html>