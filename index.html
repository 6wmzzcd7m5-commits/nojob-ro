<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jobless RO v3.0 | Prime Engine</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="lang-en">

<div id="app">
    <header class="panel" style="border-color: var(--neon);">
        <div class="flex" style="border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px;">
            <div class="flex" style="gap:5px">
                <button class="btn-sm" onclick="G.exp()">SAVE</button>
                <button class="btn-sm" onclick="G.rank()" style="color:var(--zeny)">RANK</button>
            </div>
            <div class="c-n">ZONE_FLR: <span id="ui-floor">1</span></div>
        </div>
        
        <div class="flex">
            <div style="flex:1;">
                <div class="flex">
                    <b id="ui-job" class="c-n">Novice</b>
                    <div>Lv <span id="ui-lvl">1</span></div>
                </div>
                <div class="bar-container"><div id="hp-fill" class="fill"></div></div>
                <div class="bar-container" style="height:2px; margin-top:2px; border:none; background:transparent;">
                    <div id="atb-fill" style="width:0%; height:100%; background:rgba(255,255,255,0.2);"></div>
                </div>
            </div>
        </div>

        <div class="grid g-6" style="margin-top:8px;">
            <div class="stat-cell">STR<b id="ui-str">1</b></div>
            <div class="stat-cell">AGI<b id="ui-agi">1</b></div>
            <div class="stat-cell">VIT<b id="ui-vit">1</b></div>
            <div class="stat-cell">INT<b id="ui-int">1</b></div>
            <div class="stat-cell">DEX<b id="ui-dex">1</b></div>
            <div class="stat-cell">LUK<b id="ui-luk">1</b></div>
        </div>
    </header>

    <section id="stage" class="panel" style="display:flex; justify-content: space-around; height: 140px; align-items: flex-end; position:relative;">
        <div id="p-box" class="avatar-box">
            <div id="p-spr" class="spr"><div class="hd"></div><div class="bd"></div></div>
        </div>
        <div id="e-box" class="avatar-box">
            <div id="e-spr" class="spr"><div class="hd"></div><div class="bd"></div></div>
            <small id="e-name" style="position:absolute; bottom:-15px; font-size:9px; color:var(--hp)"></small>
        </div>
    </section>

    <main id="ctl" class="grid" style="margin-top:10px; min-height:120px;"></main>

    <footer id="log" class="panel" style="height: 80px; overflow: hidden; font-size: 9px; display: flex; flex-direction: column-reverse;"></footer>
</div>

<script src="db.js"></script>
<script src="items.js"></script>

<script>
const el = i => document.getElementById(i);

const G = {
    p: null, 
    s: { f:1, b:false, atb:0, loop:null, mob:null, repo: "6wmzzcd7m5-commits/nojob-ro" },

    // 1. ENGINE INITIALIZATION
    boot() {
        const saved = localStorage.getItem('ro_prime_v3');
        if(saved) {
            this.p = JSON.parse(atob(saved));
            this.s.f = this.p.floor || 1;
            this.loadScene('mnu');
        } else {
            this.loadScene('reg');
        }
    },

    // 2. TICK SYSTEM: 30ms Heartbeat (Section 2.B)
    startLoop() {
        if(this.s.loop) clearInterval(this.s.loop);
        this.s.loop = setInterval(() => {
            if(!this.s.b) return;
            
            // Fill Rate = Base_Job_ASPD + (AGI * 0.8) + (DEX * 0.2)
            const fillRate = (DB.jobs[this.p.job].aspd || 150) + (this.p.agi * 0.8) + (this.p.dex * 0.2);
            this.s.atb += (fillRate / 10);
            el('atb-fill').style.width = Math.min(100, this.s.atb / 10) + "%";

            if(this.s.atb >= 1000) {
                this.s.atb = 0;
                this.executeAction();
            }
        }, 30); // 30ms Tick Rate
    },

    // 3. COMBAT LOGIC (Section 2.B)
    executeAction() {
        // ATK = STR + [DEX/5] + [LUK/3] + (LVL * 2)
        const atk = this.p.str + Math.floor(this.p.dex/5) + Math.floor(this.p.luk/3) + (this.p.lvl * 2);
        const dmg = Math.max(1, atk - (this.s.mob.def || 0));
        
        // Visual Lung Animation
        const spr = el('p-spr');
        spr.classList.remove('lung');
        void spr.offsetWidth; 
        spr.classList.add('lung');

        this.s.mob.hp -= dmg;
        this.pop(dmg, 'e-box');
        
        if(this.s.mob.hp <= 0) this.resolveWin();
    },

    resolveWin() {
        this.s.b = false;
        this.p.lvl++; this.s.f++; this.p.floor = this.s.f;
        this.log(`TARGET ELIMINATED. FLOOR CLEAR!`, "c-n");
        this.sv();
        this.render();
        this.loadScene('mnu');
    },

    // 4. ISSUEOPS RANKING (Section 1.B)
    rank() {
        const hash = this.djb2(this.p.n + this.p.job + this.s.f + DB_ITEMS.SALT);
        const payload = {
            name: this.p.n,
            job: this.p.job,
            floor: this.s.f,
            lvl: this.p.lvl,
            hash: hash
        };
        const body = encodeURIComponent(JSON.stringify(payload));
        const url = `https://github.com/${this.s.repo}/issues/new?title=RANK_SUBMISSION&body=${body}`;
        window.open(url, '_blank');
    },

    djb2(str) {
        let hash = 5381;
        for (let i = 0; i < str.length; i++) {
            hash = ((hash << 5) + hash) + str.charCodeAt(i);
        }
        return hash >>> 0;
    },

    // 5. UI RENDERER
    render() {
        if(!this.p) return;
        el('ui-job').innerText = this.p.job;
        el('ui-lvl').innerText = this.p.lvl;
        el('ui-floor').innerText = this.s.f;
        
        const hpPct = Math.max(0, (this.p.hp / this.p.mh) * 100);
        el('hp-fill').style.width = hpPct + "%";
        
        ['str','agi','vit','int','dex','luk'].forEach(k => el('ui-'+k).innerText = this.p[k]);
        el('p-spr').className = `spr j-${this.p.job}`;
    },

    loadScene(name) {
        const c = el('ctl');
        if(name === 'reg') {
            c.innerHTML = `
                <div class="panel grid g-1">
                    <input id="pname" placeholder="IDENT_ID..." class="panel" style="width:100%; background:#000; color:var(--neon); border-style:dashed;">
                    <button onclick="G.initChar()" class="panel" style="width:100%; color:var(--neon); background:#000;">INITIALIZE_IDENTITY</button>
                </div>`;
        } else if(name === 'mnu') {
            c.innerHTML = `
                <button onclick="G.startBattle()" class="panel" style="width:100%; color:var(--neon); background:#000; padding:20px;">WARP_TO_FLOOR_${this.s.f}</button>
                <button onclick="G.rest()" class="panel" style="width:100%; color:var(--neon); background:#000; font-size:9px;">RECOVERY_SYNC</button>`;
        }
    },

    initChar() {
        const name = el('pname').value || "Novice_" + Math.floor(Math.random()*999);
        this.p = { n: name, job:'Novice', lvl:1, str:5, agi:5, vit:5, int:5, dex:5, luk:5, hp:100, mh:100, floor:1 };
        this.sv(); this.render(); this.loadScene('mnu');
    },

    startBattle() {
        this.s.mob = DB.mobs.scaling(this.s.f);
        el('e-name').innerText = this.s.mob.n.toUpperCase();
        this.s.b = true; this.s.atb = 0;
        this.startLoop();
        el('ctl').innerHTML = `<div class="panel" style="text-align:center; border-style:dotted; color:var(--hp)">AUTO_COMBAT_ACTIVE</div>`;
    },

    rest() { this.p.hp = this.p.mh; this.render(); this.log("SYNC COMPLETE: VITALS 100%"); },
    pop(amt, id) {
        const d = document.createElement('div');
        d.className = 'dmg-pop'; d.innerText = amt;
        el(id).appendChild(d);
        setTimeout(() => d.remove(), 800);
    },
    log(m, c) { el('log').insertAdjacentHTML('afterbegin', `<div class="entry ${c}">> ${m}</div>`); },
    sv() { localStorage.setItem('ro_prime_v3', btoa(JSON.stringify(this.p))); },
    exp() { const a=document.createElement('a'); a.href='data:text/plain;base64,'+btoa(JSON.stringify(this.p)); a.download='save.jro'; a.click(); }
};

window.onload = () => G.boot();
</script>
</body>
</html>
