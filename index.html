<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jobless RO v3.0 | Prime Engine</title>
    <link rel="stylesheet" href="style.css">
</head>
<body class="lang-en">

<div id="app">
    <header class="panel" style="border-color: var(--neon);">
        <div class="flex" style="border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:5px;">
            <div class="flex" style="gap:5px">
                <button class="btn-sm" onclick="G.exp()">SAVE</button>
                <button class="btn-sm" onclick="G.rank()" style="color:var(--zeny)">RANK</button>
            </div>
            <div class="flex" style="gap:2px">
                <button class="btn-sm spd-btn active" id="spd-1" onclick="G.setSpd(1)">1x</button>
                <button class="btn-sm spd-btn" id="spd-5" onclick="G.setSpd(5)">5x</button>
                <button class="btn-sm spd-btn" id="spd-20" onclick="G.setSpd(20)">20x</button>
            </div>
            <div class="c-n">FLR: <span id="ui-floor">1</span></div>
        </div>
        
        <div class="flex">
            <div style="flex:1;">
                <div class="flex">
                    <b id="ui-job" class="c-n">Novice</b>
                    <div>Lv <span id="ui-lvl">1</span></div>
                </div>
                <div class="bar-container"><div id="hp-fill" class="fill"></div></div>
                <div class="bar-container" style="height:2px; margin-top:2px; border:none; background:transparent;">
                    <div id="atb-fill" style="width:0%; height:100%; background:rgba(57, 255, 20, 0.4);"></div>
                </div>
            </div>
        </div>

        <div class="grid g-6" style="margin-top:8px;">
            <div class="stat-cell">STR<b id="ui-str">1</b></div>
            <div class="stat-cell">AGI<b id="ui-agi">1</b></div>
            <div class="stat-cell">VIT<b id="ui-vit">1</b></div>
            <div class="stat-cell">INT<b id="ui-int">1</b></div>
            <div class="stat-cell">DEX<b id="ui-dex">1</b></div>
            <div class="stat-cell">LUK<b id="ui-luk">1</b></div>
        </div>
    </header>

    <section id="stage" class="panel">
        <div id="p-box" class="avatar-box"><div id="p-spr" class="spr"><div class="hd"></div><div class="bd"></div></div></div>
        <div id="e-box" class="avatar-box">
            <div id="e-spr" class="spr"><div class="hd"></div><div class="bd"></div></div>
            <small id="e-name" style="position:absolute; bottom:-15px; font-size:9px; color:var(--hp)"></small>
        </div>
    </section>

    <main id="ctl" class="grid" style="margin-top:10px; min-height:120px;"></main>
    <footer id="log" class="panel"></footer>
</div>

<script src="db.js"></script>
<script src="items.js"></script>

<script>
const el = i => document.getElementById(i);

const G = {
    p: null, 
    s: { f:1, b:false, atb:0, loop:null, mob:null, spd: 1, repo: "6wmzzcd7m5-commits/nojob-ro" },

    boot() {
        const saved = localStorage.getItem('ro_prime_v3');
        if(saved) {
            this.p = JSON.parse(atob(saved));
            this.s.f = this.p.floor || 1;
            this.loadScene('mnu');
        } else {
            this.loadScene('reg');
        }
    },

    // DYNAMIC SPEED CONTROL
    setSpd(val) {
        this.s.spd = val;
        document.querySelectorAll('.spd-btn').forEach(b => b.classList.remove('active'));
        el('spd-' + val).classList.add('active');
        if(this.s.b) this.startLoop(); // Restart loop with new speed if in battle
        this.log("TIMELINE_ACCELERATION: " + val + "X", "c-yel");
    },

    // 30ms LOOP SYSTEM (Section 2.B)
    startLoop() {
        if(this.s.loop) clearInterval(this.s.loop);
        // Interval is shortened based on speed (30ms / speed)
        const tickRate = Math.max(1, 30 / this.s.spd); 
        this.s.loop = setInterval(() => {
            if(!this.s.b) return;
            
            const fillRate = (DB.jobs[this.p.job].aspd || 150) + (this.p.agi * 0.8) + (this.p.dex * 0.2);
            this.s.atb += (fillRate / 10);
            el('atb-fill').style.width = Math.min(100, this.s.atb / 10) + "%";

            if(this.s.atb >= 1000) {
                this.s.atb = 0;
                this.executeAction();
            }
        }, tickRate);
    },

    executeAction() {
        const atk = this.p.str + Math.floor(this.p.dex/5) + Math.floor(this.p.luk/3) + (this.p.lvl * 2);
        const dmg = Math.max(1, atk - (this.s.mob.def || 0));
        
        const spr = el('p-spr');
        spr.classList.remove('lung');
        void spr.offsetWidth; 
        spr.classList.add('lung');

        this.s.mob.hp -= dmg;
        this.pop(dmg, 'e-box');
        
        if(this.s.mob.hp <= 0) this.resolveWin();
    },

    resolveWin() {
        this.s.b = false;
        if(this.s.loop) clearInterval(this.s.loop);
        this.p.lvl++; this.s.f++; this.p.floor = this.s.f;
        this.log(`TARGET ELIMINATED. FLOOR CLEAR!`, "c-n");
        this.sv(); this.render(); this.loadScene('mnu');
    },

    rank() {
        const hash = getSecureHash(this.p);
        const payload = { name: this.p.n, job: this.p.job, floor: this.s.f, lvl: this.p.lvl, hash: hash };
        const body = encodeURIComponent(JSON.stringify(payload));
        window.open(`https://github.com/${this.s.repo}/issues/new?title=RANK_SUBMISSION&body=${body}`, '_blank');
    },

    render() {
        if(!this.p) return;
        el('ui-job').innerText = this.p.job;
        el('ui-lvl').innerText = this.p.lvl;
        el('ui-floor').innerText = this.s.f;
        el('hp-fill').style.width = Math.max(0, (this.p.hp / this.p.mh) * 100) + "%";
        ['str','agi','vit','int','dex','luk'].forEach(k => el('ui-'+k).innerText = this.p[k]);
        el('p-spr').className = `spr j-${this.p.job}`;
    },

    loadScene(name) {
        const c = el('ctl');
        if(name === 'reg') {
            c.innerHTML = `<div class="panel grid g-1"><input id="pname" placeholder="IDENT_ID..." class="panel" style="width:100%; background:#000; color:var(--neon);"><button onclick="G.initChar()" class="panel" style="width:100%; color:var(--neon); background:#000;">BOOT_SYSTEM</button></div>`;
        } else if(name === 'mnu') {
            c.innerHTML = `<button onclick="G.startBattle()" class="panel" style="width:100%; color:var(--neon); background:#000; padding:20px;">WARP_TO_FLOOR_${this.s.f}</button>`;
        }
    },

    initChar() {
        const n = el('pname').value || "Novice";
        this.p = { n, job:'Novice', lvl:1, str:5, agi:5, vit:5, int:5, dex:5, luk:5, hp:100, mh:100, floor:1 };
        this.sv(); this.render(); this.loadScene('mnu');
    },

    startBattle() {
        this.s.mob = DB.mobs.scaling(this.s.f);
        el('e-box').setAttribute('data-tier', Math.ceil(this.s.f / 10));
        el('e-name').innerText = this.s.mob.n.toUpperCase();
        this.s.b = true; this.s.atb = 0;
        this.startLoop();
        el('ctl').innerHTML = `<div class="panel" style="text-align:center; color:var(--hp)">AUTO_COMBAT_ACTIVE</div>`;
    },

    pop(amt, id) {
        const d = document.createElement('div');
        d.className = 'dmg-pop'; d.innerText = amt;
        el(id).appendChild(d);
        setTimeout(() => d.remove(), 800 / this.s.spd); // Speed up popups too
    },
    log(m, c) { el('log').insertAdjacentHTML('afterbegin', `<div class="entry ${c}">> ${m}</div>`); },
    sv() { localStorage.setItem('ro_prime_v3', btoa(JSON.stringify(this.p))); },
    exp() { const a=document.createElement('a'); a.href='data:text/plain;base64,'+btoa(JSON.stringify(this.p)); a.download='save.jro'; a.click(); }
};

window.onload = () => G.boot();
</script>
</body>
</html>
