<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jobless RO v1.02 | Ultimate Edition</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="spr.css">
</head>

<body class="lang-en" style="background:#000;">

    <div id="app">
        <header class="panel main-hud">
            <div class="flex hud-top">
                <div class="flex nav-btns">
                    <button class="btn-sm" id="btn-save" onclick="G.exp()">SAVE</button>
                    <button class="btn-sm btn-red" id="btn-reset" onclick="G.reset()">RESET</button>
                    <button class="btn-sm btn-yel" id="btn-rank" onclick="G.loadRank()">RANK</button>
                    <button class="btn-sm" onclick="G.toggleLang()">EN/繁</button>
                </div>
                <button class="btn-sm" id="btn-speed" onclick="G.cycleSpd()" style="min-width:40px;">1x</button>
            </div>

            <div class="flex player-info">
                <div style="flex:1;">
                    <div class="flex info-row">
                        <div class="name-job">
                            <span id="ui-name" class="c-n name-text">Novice</span>
                            <b id="ui-job" class="c-n job-text">Novice</b>
                        </div>
                        <div class="lvl-box"><span id="lbl-lv">Lv</span> <span id="ui-lvl">1</span></div>
                    </div>
                    <div class="bar-container hp-bar">
                        <div id="hp-fill" class="fill"></div>
                        <div id="hp-text" class="bar-text">0/0</div>
                    </div>
                    <div class="bar-container atb-bar-mini">
                        <div id="atb-fill" class="fill atb-fill"></div>
                    </div>
                </div>
            </div>

            <div class="grid g-6 battle-stats">
                <div class="stat-cell"><span id="lbl-atk">ATK</span><b id="ui-atk">0</b></div>
                <div class="stat-cell"><span id="lbl-matk">MATK</span><b id="ui-matk">0</b></div>
                <div class="stat-cell"><span id="lbl-cri">CRI</span><b id="ui-cri">0</b></div>
                <div class="stat-cell"><span id="lbl-hit">HIT</span><b id="ui-hit">0</b></div>
                <div class="stat-cell"><span id="lbl-flee">FLEE</span><b id="ui-flee">0</b></div>
                <div class="stat-cell"><span id="lbl-def">DEF</span><b id="ui-def">0</b></div>
            </div>

            <div class="grid g-6 primary-stats">
                <div class="stat-cell"><span id="lbl-str">STR</span><b id="ui-str">1</b></div>
                <div class="stat-cell"><span id="lbl-agi">AGI</span><b id="ui-agi">1</b></div>
                <div class="stat-cell"><span id="lbl-vit">VIT</span><b id="ui-vit">1</b></div>
                <div class="stat-cell"><span id="lbl-int">INT</span><b id="ui-int">1</b></div>
                <div class="stat-cell"><span id="lbl-dex">DEX</span><b id="ui-dex">1</b></div>
                <div class="stat-cell"><span id="lbl-luk">LUK</span><b id="ui-luk">1</b></div>
            </div>

            <div class="flex world-info">
                <div id="ui-loc" class="c-ora loc-text">Prontera Field</div>
                <div class="c-n floor-box"><span id="lbl-flr">FLR</span>: <span id="ui-floor">1</span></div>
            </div>
        </header>

        <section id="stage" class="panel">
            <div id="p-box" class="avatar-box">
                <div id="p-spr" class="spr">
                    <div class="hd">
                        <div class="pony"></div>
                    </div>
                    <div class="bd"></div>
                </div>
            </div>
            <div id="e-box" class="avatar-box">
                <div id="e-spr" class="spr">
                    <div class="hd"></div>
                    <div class="bd"></div>
                </div>
                <small id="e-name" class="enemy-name"></small>
                <div class="enemy-vitals">
                    <div class="bar-container e-hp">
                        <div id="e-hp-fill" class="fill"></div>
                    </div>
                    <div class="bar-container e-atb">
                        <div id="e-atb-fill" class="fill"></div>
                    </div>
                </div>
            </div>
        </section>

        <div id="inv-hud" class="panel inventory-panel"></div>
        <div id="skill-hud" class="panel skill-panel"></div>

        <main id="ctl" class="grid"></main>
        <footer id="log" class="panel log-panel"></footer>
    </div>

    <script src="db.js"></script>
    <script src="items.js"></script>
    <script src="stat.js"></script>
    <script src="scenes.js"></script>
    <script src="ui.js"></script>

    <script>
        const el = i => document.getElementById(i);
        const G = {
            p: null,
            s: { f: 1, b: false, atb: 0, eatb: 0, loop: null, mob: null, spd: 1, repo: "6wmzzcd7m5-commits/nojob-ro", tmpG: 'm', subAt: 0 },

            boot() {
                const saved = localStorage.getItem('ro_prime_v3');
                if (saved) {
                    this.p = JSON.parse(atob(saved));
                    if (!this.p.items) this.p.items = {};
                    if (!this.p.hair) this.p.hair = `hsl(${Math.random() * 360}, 50%, 40%)`;
                    this.s.f = this.p.floor || 1;
                    if (this.p.pts > 0) UI.loadScene('stats', this.p, this.s);
                    else UI.loadScene('mnu', this.p, this.s);
                } else {
                    const hair = `hsl(${Math.random() * 360}, 50%, 40%)`;
                    this.p = { n: "JOBLESS", job: "Novice", gender: 'm', lvl: 1, str: 1, agi: 1, vit: 1, int: 1, dex: 1, luk: 1, hp: 1, mh: 1, items: {}, hair };
                    UI.loadScene('start', this.p, this.s);
                }
                document.documentElement.style.setProperty('--hair', this.p.hair);
                UI.render(this.p, this.s);
                if (!saved) this.startPreview();
                console.log("GAME_BOOT: SUCCESS_V1.02");
            },

            startPreview() {
                if (this.s.pvw) clearInterval(this.s.pvw);
                const rotate = () => {
                    if (!DB.mobs || !DB.mobs.names) return;
                    const m = DB.mobs.names[Math.floor(Math.random() * DB.mobs.names.length)];
                    const name = m.replace(/ \[MVP\]/g, '');
                    const cls = name.replace(/\s+/g, '-');
                    el('e-spr').className = `spr ${m.includes('[MVP]') ? 'spr-mvp' : ''} m-${cls}`;
                    el('e-name').innerText = DB.getName('mobs', m);
                    el('e-hp-fill').style.width = "100%";
                };
                rotate();
                this.s.pvw = setInterval(rotate, 3000);
            },

            showReg() {
                if (this.s.pvw) clearInterval(this.s.pvw);
                UI.loadScene('reg', this.p, this.s);
            },

            reset() { if (confirm(DB.txt('confirm_reset'))) { localStorage.removeItem('ro_prime_v3'); location.reload(); } },

            setG(val) {
                this.s.tmpG = val;
                const spr = el('reg-spr');
                if (spr) spr.className = `spr j-Novice ${val === 'f' ? 'ro-f' : 'ro-m'}`;
                const pspr = el('p-spr');
                if (pspr) pspr.className = `spr j-Novice ${val === 'f' ? 'ro-f' : 'ro-m'}`;
            },

            initChar() {
                if (this.s.pvw) clearInterval(this.s.pvw);
                const n = el('pname').value || "Novice";
                const d = parseFloat(el('pdiff').value) || 1.0;
                const skills = ['First Aid', 'Basic Skill'];
                const hair = `hsl(${Math.random() * 360}, 50%, 40%)`;
                this.p = { n, gender: this.s.tmpG || 'm', diff: d, job: 'Novice', lvl: 1, str: 5, agi: 5, vit: 5, int: 5, dex: 5, luk: 5, hp: 1, mh: 1, floor: 1, items: {}, wpn: null, arm: null, skills, pts: 10, hair };
                STATS.refreshVitals(this.p);
                this.p.hp = this.p.mh;
                document.documentElement.style.setProperty('--hair', this.p.hair);
                this.sv(); UI.render(this.p, this.s); UI.loadScene('stats', this.p, this.s);
            },

            toggleLang() {
                document.body.classList.toggle('lang-tc');
                UI.render(this.p, this.s);
                UI.loadScene(this.s.b ? 'btl' : (this.s.scene || 'mnu'), this.p, this.s);
            },

            cycleSpd() {
                const spds = [1, 5, 20];
                this.s.spd = spds[(spds.indexOf(this.s.spd) + 1) % spds.length];
                if (this.s.b) this.startLoop();
                UI.render(this.p, this.s);
                UI.log(DB.txt('speed') + " " + this.s.spd + "X", "c-yel");
            },

            startLoop() {
                if (this.s.loop) clearInterval(this.s.loop);
                this.s.loop = setInterval(() => {
                    if (!this.s.b) return;
                    const job = DB.getJob(this.p.job);

                    // Player Attack Bar Logic
                    this.s.atb += ((job.aspd + (this.p.agi * 0.8) + (this.p.dex * 0.2)) / 10);
                    el('atb-fill').style.width = Math.min(100, this.s.atb / 10) + "%";

                    // Enemy Attack Bar Logic
                    const eFill = 150 + (this.s.f * 2);
                    this.s.eatb += (eFill / 10);
                    el('e-atb-fill').style.width = Math.min(100, this.s.eatb / 10) + "%";

                    if (this.s.atb >= 1000) { this.s.atb = 0; this.pAttack(); }
                    if (this.s.eatb >= 1000) { this.s.eatb = 0; this.eAttack(); }
                }, 30 / this.s.spd);
            },

            pAttack() {
                let baseDmg = Math.max(1, parseInt(el('ui-atk').innerText) - (this.s.mob.def || 0));
                let skillName = "";
                let skillData = null;

                // 1. Skill Trigger Check (Only use Active skills)
                if (this.p.skills && this.p.skills.length > 0 && Math.random() < 0.10) {
                    const activePool = this.p.skills.filter(sn => {
                        for (let c in DB.skills) if (DB.skills[c][sn] && DB.skills[c][sn].mode === 'act') return true;
                        return false;
                    });

                    if (activePool.length > 0) {
                        skillName = activePool[Math.floor(Math.random() * activePool.length)];
                        for (let c in DB.skills) if (DB.skills[c][skillName]) skillData = DB.skills[c][skillName];
                    }
                }

                // 2. Skill Execution
                if (skillData) {
                    UI.log(`${DB.txt('skill')}! : ${DB.getName('skills', skillName)}`, "c-yel");

                    // Determine Skill Color based on Element
                    let sCol = 'c-yel';
                    if (skillData.element === 'fire') sCol = 'c-ora';
                    if (skillData.element === 'water' || skillData.element === 'cold' || skillData.element === 'wind') sCol = 'c-blu';
                    if (skillData.element === 'poison') sCol = 'c-grn'; // Keep green for poison

                    // Special: Healing Skills (Canonical Effect: recover hp)
                    if (skillData.effect === 'heal') {
                        const healAmt = Math.floor(baseDmg * skillData.mult);
                        this.p.hp = Math.min(this.p.mh, this.p.hp + healAmt);
                        UI.render(this.p, this.s);
                        UI.pop(healAmt, 'p-box', 'c-grn'); // Use green for healing
                        return;
                    }

                    // Special: Multi-Hit & Bonus Targeting
                    let totalHits = skillData.hits || 1;
                    if (skillData.bonus) {
                        const isTarget = Array.isArray(skillData.bonus.target)
                            ? skillData.bonus.target.some(t => this.s.mob.n.includes(t))
                            : this.s.mob.n.includes(skillData.bonus.target);
                        if (isTarget) totalHits = skillData.bonus.hits;
                    }

                    for (let i = 0; i < totalHits; i++) {
                        setTimeout(() => {
                            if (this.s.mob.hp <= 0) return;
                            const hitDmg = Math.floor(baseDmg * skillData.mult);
                            this.s.mob.hp -= hitDmg;
                            el('e-hp-fill').style.width = (Math.max(0, this.s.mob.hp) / this.s.mob.mhp * 100) + "%";
                            UI.pop(hitDmg, 'e-box', sCol);
                            if (this.s.mob.hp <= 0) this.resolveWin();
                        }, i * 150);
                    }
                } else {
                    // 3. Normal Attack / Critical Hit
                    const criRate = parseFloat(el('ui-cri').innerText) / 100;
                    const isCrit = Math.random() < criRate;
                    let dmg = isCrit ? Math.floor(baseDmg * 1.5) : baseDmg;
                    if (isCrit) UI.log(DB.txt('crit'), "c-yel");

                    this.s.mob.hp -= dmg;
                    el('e-hp-fill').style.width = (Math.max(0, this.s.mob.hp) / this.s.mob.mhp * 100) + "%";
                    UI.pop(dmg, 'e-box', isCrit ? 'c-yel' : '');
                    if (this.s.mob.hp <= 0) this.resolveWin();
                }

                el('p-spr').classList.add('lung'); setTimeout(() => el('p-spr').classList.remove('lung'), 150);
            },

            eAttack() {
                const def = parseInt(el('ui-def').innerText);
                const dmg = Math.max(1, this.s.mob.atk - def);
                el('e-spr').classList.add('lung'); setTimeout(() => el('e-spr').classList.remove('lung'), 150);
                this.p.hp -= dmg;
                UI.render(this.p, this.s);
                UI.pop(dmg, 'p-box', 'c-red');
                if (this.p.hp <= 0) this.resolveLoss();
            },

            resolveWin() {
                this.s.b = false; clearInterval(this.s.loop);

                // 1. Roll for Shared Loot Pool (Potions, Gear)
                DB_ITEMS.pool.forEach(i => {
                    if (Math.random() < i.rate) {
                        const item = { ...i };
                        if (item.category === 'weapon') {
                            if (!this.p.wpn || item.val > this.p.wpn.val) {
                                this.p.wpn = item;
                                UI.log(`${DB.txt('equip')} ${DB_ITEMS.getName(item.n)}`, "c-yel");
                            }
                        } else if (item.category === 'armor') {
                            if (!this.p.arm || item.val > this.p.arm.val) {
                                this.p.arm = item;
                                UI.log(`${DB.txt('equip')} ${DB_ITEMS.getName(item.n)}`, "c-yel");
                            }
                        } else {
                            if (!this.p.items) this.p.items = {};
                            this.p.items[item.n] = (this.p.items[item.n] || 0) + 1;
                            UI.log(`+ ${DB_ITEMS.getName(item.n)}`, "c-yel");
                        }
                    }
                });

                // 2. Roll for Specific Monster Card (1.5% Chance)
                if (this.s.mob.card && Math.random() < 0.015) {
                    if (!this.p.items) this.p.items = {};
                    this.p.items[this.s.mob.card] = (this.p.items[this.s.mob.card] || 0) + 1;
                    UI.log(`${DB.txt('card_get')} ${DB_ITEMS.getName(this.s.mob.card)}`, "c-yel");
                }

                // 10% Random Event trigger
                if (Math.random() < 0.10) {
                    const events = [
                        { effect: () => { this.p.str += 1; UI.log(DB.txt('event_atk'), "c-n"); } },
                        { effect: () => { this.p.int += 1; UI.log(DB.txt('event_matk'), "c-n"); } },
                        { effect: () => { this.p.mh += 10; UI.log(DB.txt('event_hp'), "c-n"); } }
                    ];
                    events[Math.floor(Math.random() * events.length)].effect();
                }

                // NEW: Every floor, level up + Generate 1-3 Stat Points
                this.p.lvl++;
                const newPts = STATS.genPoints();
                this.p.pts = (this.p.pts || 0) + newPts;
                UI.log(`${DB.txt('level_up')} (+${newPts} ${DB.txt('stats')})`, "c-yel");

                this.s.f++; this.p.floor = this.s.f;
                STATS.refreshVitals(this.p);
                this.p.hp = this.p.mh;

                // Hidden Leaderboard Submission (Floor 50+ only)
                if (this.s.f > 50 && !this.s.subAt) {
                    this.submitScore();
                    this.s.subAt = this.s.f; // Only submit once per run
                }

                // Logic: 1 of 3 Skill Draft every 5 levels
                if (this.p.lvl % 5 === 0) {
                    this.triggerDraft();
                } else if (this.p.lvl === 10 || this.p.lvl === 40) {
                    UI.loadScene('job', this.p, this.s);
                } else {
                    UI.loadScene('stats', this.p, this.s);
                }

                this.sv(); UI.render(this.p, this.s);
            },

            triggerDraft() {
                const jobType = DB.getJob(this.p.job).type || 'melee';
                const tier = this.p.lvl >= 40 ? 2 : 1;

                const skillPool = [];
                for (let category in DB.skills) {
                    for (let sName in DB.skills[category]) {
                        const sData = DB.skills[category][sName];
                        if (sData.tier <= tier && !this.p.skills.includes(sName)) {
                            skillPool.push(sName);
                        }
                    }
                }

                // Randomly pick 3 from pool
                const draft = [];
                while (draft.length < 3 && skillPool.length > 0) {
                    const idx = Math.floor(Math.random() * skillPool.length);
                    draft.push(skillPool.splice(idx, 1)[0]);
                }

                UI.loadScene('draft', draft);
            },

            addStat(key) {
                if (STATS.allocate(this.p, key)) {
                    this.sv();
                    UI.render(this.p, this.s);
                    UI.loadScene('stats', this.p, this.s);
                }
            },

            continueFlow() {
                if (this.p.pts > 0) return;
                UI.loadScene('mnu', this.p, this.s);
            },

            learnSkill(sn) {
                if (!this.p.skills) this.p.skills = [];
                this.p.skills.push(sn);
                UI.log(`${DB.txt('skill')} ${DB.getName('skills', sn)}!`, "c-blu");

                // If this draft happened at Lvl 10 or 40, follow up with job change
                if (this.p.lvl === 10 || this.p.lvl === 40) {
                    UI.loadScene('job', this.p, this.s);
                } else {
                    UI.loadScene('stats', this.p, this.s);
                }
                this.sv();
            },

            async loadRank() {
                try {
                    UI.log(DB.txt('fetching'), "c-yel");
                    const res = await fetch('leaderboard.json?t=' + Date.now());
                    const data = await res.json();
                    UI.loadScene('rank', data);
                } catch (e) {
                    UI.log(DB.txt('offline'), "c-red");
                    UI.loadScene('rank', []);
                }
            },

            async submitScore() {
                try {
                    const token = localStorage.getItem('GH_PAT'); // Setup: localStorage.setItem('GH_PAT', 'your_token')
                    if (!token) return; // Silent fail if no token configured

                    await fetch('https://api.github.com/repos/6wmzzcd7m5-commits/nojob-ro/dispatches', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Accept': 'application/vnd.github.v3+json'
                        },
                        body: JSON.stringify({
                            event_type: 'update-score',
                            client_payload: {
                                name: this.p.n || "Unknown Soldier",
                                floor: this.s.f,
                                job: DB.getName('jobs', this.p.job)
                            }
                        })
                    });
                    UI.log(DB.txt('synced'), "c-blu");
                } catch (e) {
                    console.error("Submission failed:", e);
                }
            },

            resolveLoss() {
                this.s.b = false; clearInterval(this.s.loop);
                UI.log(DB.txt('defeat'), "c-red");
                this.p.hp = this.p.mh;
                UI.loadScene('gameover', this.p, this.s);
                UI.render(this.p, this.s);
            },

            changeJob(newJob) {
                this.p.job = newJob;
                ['str', 'agi', 'vit', 'int', 'dex', 'luk'].forEach(s => this.p[s] += 5);
                STATS.refreshVitals(this.p);
                this.p.hp = this.p.mh;
                this.grantSkill();
                this.sv(); UI.render(this.p, this.s); UI.loadScene('stats', this.p, this.s);
            },

            grantSkill() {
                if (!this.p.skills) this.p.skills = [];
                let cat = "";
                for (let c in DB.jobs) if (DB.jobs[c][this.p.job]) cat = c;
                if (!cat) return;
                const tier = DB.jobs[cat][this.p.job].next.length > 0 ? 1 : 2;
                const pool = Object.keys(DB.skills[cat]).filter(k => DB.skills[cat][k].tier === tier && !this.p.skills.includes(k));
                if (pool.length > 0) {
                    const s = pool[Math.floor(Math.random() * pool.length)];
                    this.p.skills.push(s);
                    const msg = DB.getLang() === 'en' ? `LEARNED: ${s}!` : `學會技能: ${DB.getName('skills', s)}!`;
                    UI.log(msg, "c-yel");
                }
            },

            startBattle() {
                const isBoss = (this.s.f % 10 === 0);
                let mobIndex;
                if (isBoss) {
                    const bossPool = DB.mobs.names.filter(n => n.includes('[MVP]'));
                    mobIndex = DB.mobs.names.indexOf(bossPool[Math.floor(Math.random() * bossPool.length)]);
                } else {
                    const regularPool = DB.mobs.names.filter(n => !n.includes('[MVP]'));
                    mobIndex = DB.mobs.names.indexOf(regularPool[Math.floor(Math.random() * regularPool.length)]);
                }

                this.s.mob = DB.mobs.scaling(this.s.f);
                this.s.mob.n = DB.mobs.names[mobIndex];
                this.s.mob.hp *= (this.p.diff || 1.0);
                this.s.mob.atk *= (this.p.diff || 1.0);
                this.s.mob.mhp = this.s.mob.hp;

                el('e-spr').className = `spr ${this.s.mob.n.includes('[MVP]') ? 'spr-mvp' : ''} m-${this.s.mob.n.replace(/ \[MVP\]/g, '').replace(/\s+/g, '-')}`;
                el('e-name').innerText = DB.getName('mobs', this.s.mob.n); el('e-hp-fill').style.width = "100%";
                this.s.b = true; this.s.atb = 0; this.s.eatb = 0;
                this.startLoop(); UI.loadScene('btl', this.p, this.s);
            },

            sv() { localStorage.setItem('ro_prime_v3', btoa(JSON.stringify(this.p))); },
            exp() { const a = document.createElement('a'); a.href = 'data:text/plain;base64,' + btoa(JSON.stringify(this.p)); a.download = 'save.jro'; a.click(); }
        };
        window.onload = () => G.boot();
    </script>
</body>

</html>