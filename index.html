<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Jobless RO v1.2.2 | Rouge Edition</title>
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="visuals.css">
</head>
<body class="lang-en" data-l-lv-en="Level" data-l-lv-cn="等級" data-l-fl-en="Floor" data-l-fl-cn="層">

<div id="app">
    <header class="panel">
        <div class="flex" style="border-bottom:1px dashed var(--bd); padding-bottom:5px;">
            <div class="flex" style="gap:4px">
                <button class="btn-sm" onclick="G.exp()" data-t="save"></button>
                <button class="btn-sm" onclick="G.lang()">EN/中</button>
                <button class="btn-sm btn-red" onclick="G.wipe()">RESET</button>
            </div>
            <div class="flex" style="gap:10px">
                <div class="c-yel">POT: <span id="ui-pots">0</span></div>
                <div class="c-n">F<span id="ui-floor">1</span></div>
            </div>
        </div>
        
        <div class="flex" style="margin-top:8px;">
            <div style="flex:1;">
                <div class="flex">
                    <b id="ui-job" class="c-n">Novice</b>
                    <div>Lv <span id="ui-lvl">1</span></div>
                </div>
                <progress id="hp-bar" value="0" max="100"></progress>
                <progress id="sp-bar" value="0" max="100"></progress>
            </div>
        </div>

        <div class="grid g-6" id="ui-base-stats" style="margin-top:5px; border-top:1px solid #333; padding-top:4px;">
            <div class="stat-cell">STR<br><b id="ui-str">0</b></div>
            <div class="stat-cell">AGI<br><b id="ui-agi">0</b></div>
            <div class="stat-cell">VIT<br><b id="ui-vit">0</b></div>
            <div class="stat-cell">INT<br><b id="ui-int">0</b></div>
            <div class="stat-cell">DEX<br><b id="ui-dex">0</b></div>
            <div class="stat-cell">LUK<br><b id="ui-luk">0</b></div>
        </div>
        <div class="grid g-5" id="ui-sub-stats" style="margin-top:2px; background:rgba(0,0,0,0.3);">
            <div class="stat-cell">ATK<br><span id="ui-atk" class="c-n">0</span></div>
            <div class="stat-cell">MATK<br><span id="ui-matk" class="c-n">0</span></div>
            <div class="stat-cell">HIT<br><span id="ui-hit" class="c-n">0</span></div>
            <div class="stat-cell">FLEE<br><span id="ui-flee" class="c-n">0</span></div>
            <div class="stat-cell">CRI<br><span id="ui-cri" class="c-n">0%</span></div>
        </div>
    </header>

    <section id="battle-ui" class="panel" style="margin-top:5px; border-color:var(--hp)" hidden>
        <div style="text-align:center; color:var(--hp); font-weight:bold; font-size:10px" id="ui-target">TARGET</div>
        <div class="grid g-1">
            <div class="flex" style="font-size:8px">YOU <progress id="atb-p" value="0" max="100" style="width:80%"></progress></div>
            <div class="flex" style="font-size:8px">FOE <progress id="atb-e" value="0" max="100" style="width:80%"></progress></div>
        </div>
    </section>

    <section id="stage" class="panel">
        <div id="p-box" class="avatar-box">
            <div id="p-spr" class="spr"><div class="hd"></div><div class="bd"></div></div>
        </div>
        <div id="e-box" class="avatar-box">
            <div id="e-spr" class="spr"><div class="hd"></div><div class="bd"></div></div>
        </div>
    </section>

    <main id="ctl" class="grid">
        <button class="btn-neon" style="grid-column: span 2; padding: 25px; font-size: 1.2rem;" onclick="G.init()" data-t="start"></button>
    </main>

    <footer id="log" class="panel"></footer>
</div>

<script>
/**
 * JOBLESS RO ENGINE v1.2.2
 * Global State & Fragment Router
 */
const DB = {
    jobs: {
        'Novice': { next:['Swordman','Mage','Thief'], pool:['First Aid'], hp:60, sp:20, stats:[2,2,2,1,1,1] },
        'Swordman': { next:['Knight'], pool:['Bash'], hp:150, sp:40, stats:[5,3,4,1,2,1] },
        'Mage': { next:['Wizard'], pool:['Fire Bolt'], hp:80, sp:100, stats:[1,4,2,8,3,1] },
        'Thief': { next:['Assassin'], pool:['Envenom'], hp:100, sp:50, stats:[4,6,2,2,4,2] }
    },
    skills: {
        'First Aid':{sp:3, val:20, type:'heal'}, 'Bash':{sp:8, val:1.5, type:'phys'},
        'Fire Bolt':{sp:10, val:1.8, type:'mag'}, 'Envenom':{sp:10, val:1.2, type:'phys'}
    },
    mobs: [
        [{n:'Poring',hp:30,atk:5,xp:10},{n:'Lunatic',hp:45,atk:8,xp:15}],
        [{n:'Wolf',hp:150,atk:25,xp:50},{n:'Skeleton',hp:180,atk:30,xp:60}]
    ]
};

const el = i => document.getElementById(i);

const G = {
    p: null, 
    s: { f:1, b:false, tm:null, l:'en', patb:0, eatb:0 },

    // Initialization: Checks for save or starts fresh
    init() {
        const saved = localStorage.getItem('ro_rouge_v121');
        if (saved) {
            try {
                this.p = JSON.parse(atob(saved));
                this.loadScene('mnu');
            } catch(e) { this.loadScene('reg'); }
        } else {
            this.loadScene('reg');
        }
    },

    // Fragment Router: Loads HTML, executes internal script, renders HUD
    async loadScene(name) {
        try {
            const res = await fetch(`./scenes/${name}.html`);
            if (!res.ok) throw new Error();
            const html = await res.text();
            el('ctl').innerHTML = html;
            
            el('ctl').querySelectorAll('script').forEach(s => {
                const n = document.createElement('script');
                n.textContent = s.textContent;
                document.head.appendChild(n).parentNode.removeChild(n);
            });
            this.render();
        } catch(e) {
            el('ctl').innerHTML = `<button class="btn-neon" onclick="G.init()">ERROR: RETRY LOAD</button>`;
        }
    },

    // Global Render: Updates persistent UI and Calculates derived stats
    render() {
        if(!this.p) return;
        
        el('ui-job').innerText = this.p.job;
        el('ui-lvl').innerText = this.p.lvl;
        el('ui-floor').innerText = this.s.f;
        el('ui-pots').innerText = this.p.pots;
        
        el('hp-bar').value = this.p.hp; el('hp-bar').max = this.p.mh;
        el('sp-bar').value = this.p.sp; el('sp-bar').max = this.p.msp;

        ['str','agi','vit','int','dex','luk'].forEach(k => { el('ui-'+k).innerText = this.p[k]; });

        // Derived Stats Calculation
        el('ui-atk').innerText = Math.floor(this.p.str * 2.5 + this.p.lvl * 2);
        el('ui-matk').innerText = Math.floor(this.p.int * 3 + this.p.lvl * 2);
        el('ui-hit').innerText = this.p.dex + this.p.lvl;
        el('ui-flee').innerText = this.p.agi + this.p.lvl;
        el('ui-cri').innerText = Math.floor(this.p.luk * 0.5) + '%';

        el('battle-ui').hidden = !this.s.b;
        if(this.s.b && this.s.mob) el('ui-target').innerText = this.s.mob.n;
        
        el('p-spr').className = `spr j-${this.p.job}`;
        document.getElementById('stage').style.filter = 'none'; // Clear death grayscale
    },

    // Boss Warning Helper
    triggerWarning(callback) {
        const stage = el('stage');
        const warn = document.createElement('div');
        warn.className = 'warning-overlay';
        warn.innerHTML = '<div class="warning-text">BOSS WARNING</div>';
        stage.appendChild(warn);
        setTimeout(() => { warn.remove(); if(callback) callback(); }, 1500);
    },

    // State Persistence
    sv() { localStorage.setItem('ro_rouge_v121', btoa(JSON.stringify(this.p))); },
    exp() { const a=document.createElement('a'); a.href='data:text/plain;base64,'+btoa(JSON.stringify(this.p)); a.download='save.jro'; a.click(); },
    wipe() { if(confirm("Reset Progress?")){ localStorage.removeItem('ro_rouge_v121'); location.reload(); } },
    lang() { this.s.l = this.s.l==='en'?'cn':'en'; document.body.className='lang-'+this.s.l; },
    log(m, c='') {
        const l = el('log');
        l.insertAdjacentHTML('afterbegin', `<div class="entry ${c}">${m}</div>`);
        if(l.children.length > 5) l.lastElementChild.remove();
    }
};
</script>
</body>
</html>
